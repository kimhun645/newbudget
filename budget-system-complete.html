<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดทำงบประมาณประจำปี</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { motion, AnimatePresence } = window.FramerMotion;
        const { 
            Calculator, Settings, Car, Heart, Home, Users, RotateCcw, 
            Banknote, Clock, Calendar, BarChart3, FileText, Shield, 
            Database, Layout, Plus, Trash2, UserCheck, UserX, Save, 
            Download, Upload, Info, Edit3, Check, X, ChevronLeft, 
            ChevronRight, TrendingUp, TrendingDown, PieChart, Filter,
            AlertTriangle, CheckCircle, XCircle, RefreshCw, Target,
            MapPin, Award, AlertCircle, DollarSign, Male, Female,
            Loader2
        } = window.LucideReact;

        // Storage Manager
        const STORAGE_KEYS = {
            BUDGET: 'budgetSystem_budgetData_v3',
            EMPLOYEES: 'budgetSystem_employeeData_v2',
            ASSIST1: 'budgetSystem_assist1Data_v1',
            OVERTIME: 'budgetSystem_overtimeData_v1',
            MASTER_RATES: 'budgetSystem_masterRates_v1',
            HOLIDAYS: 'budgetSystem_holidaysData_v1',
        };

        class StorageManager {
            static save(key, data) {
                try {
                    localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(data));
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                    throw new Error('ไม่สามารถบันทึกข้อมูลได้ อาจเป็นเพราะพื้นที่จัดเก็บเต็ม');
                }
            }

            static load(key, defaultValue) {
                try {
                    const stored = localStorage.getItem(STORAGE_KEYS[key]);
                    return stored ? JSON.parse(stored) : defaultValue;
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                    return defaultValue;
                }
            }

            static remove(key) {
                localStorage.removeItem(STORAGE_KEYS[key]);
            }

            static clear() {
                Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
            }
        }

        // Default Data
        const defaultBudgetItems = [
            { type: 'main_header', name: 'รวมงบประมาณรายจ่ายดำเนินงาน' },
            { type: 'header', name: 'หมวด 1 : ค่าใช้จ่ายเกี่ยวกับพนักงาน' },
            { code: '52021100', name: 'ค่าใช้จ่ายกิจกรรมส่งเสริมค่านิยมร่วมขององค์กร', notes: '' },
            { code: '52010700', name: 'ค่าล่วงเวลา', notes: '' },
            { type: 'header', name: 'หมวด 2 : ค่าใช้จ่ายดำเนินงานทั่วไป' },
            { code: '53010200', name: 'ค่าไฟฟ้า', notes: '' },
            { code: '53010300', name: 'ค่าน้ำประปา', notes: '' },
            { code: '53010400', name: 'ค่าโทรศัพท์', notes: '' },
            { code: '53040100', name: 'ค่าวัสดุทั่วไป', notes: '' },
            { code: '53040200', name: 'ค่าวัสดุงานบ้านงานครัว', notes: '' },
            { code: '53050100', name: 'ค่าน้ำมันเชื้อเพลิง', notes: '' },
            { code: '53100001', name: 'ค่าจ้าง', notes: '' },
            { code: '53010100', name: 'ค่าไปรษณียากรและพัสดุไปรษณีย์', notes: '' },
            { code: '53050500', name: 'ค่าขนส่ง', notes: '' },
            { code: '53100400', name: 'ค่าจ้างแรงงานและทำของ', notes: '' },
            { code: '53103900', name: 'ค่าจ้างแรงงาน/ทำของ-งานตามพันธกิจหลัก', notes: '' },
            { code: '53021100', name: 'ค่าซ่อมแซมและบำรุงรักษา', notes: '' },
            { code: '53060600', name: 'ค่าตอบแทน', notes: '' },
            { code: '53100004', name: 'ค่าเช่า', notes: '' },
            { code: '53040300', name: 'ค่าเช่าเครื่องถ่ายเอกสาร', notes: '' },
            { code: '53050200', name: 'ค่าเช่ายานพาหนะ', notes: '' },
            { code: '53070400', name: 'ค่าธรรมเนียม', notes: '' },
            { code: '53100100', name: 'ค่ารับรอง', notes: '' },
            { code: '53100200', name: 'ค่าใช้จ่ายในการเดินทาง', notes: '' },
            { code: '53100201', name: 'ค่าเดินทางเยี่ยมครอบครัว', notes: '' },
            { code: '53100202', name: 'ค่าเดินทางหมุนเวียนงาน ผจศ.', notes: '' },
            { code: '53101000', name: 'ค่าทรัพยากรสาสนเทศห้องสมุด', notes: '' },
            { code: '53103600', name: 'ค่าจัดประชุม/ชี้แจง', notes: '' },
            { code: '53101500', name: 'ค่าใช้จ่ายในการจัดงานและพิธีต่าง ๆ', notes: '' },
            { code: '53109900', name: 'ค่าใช้จ่ายเบ็ดเตล็ด', notes: '' },
            { type: 'header', name: 'หมวด 4 : เงินช่วยเหลือภายในนอกและเงินบริจาค' },
            { code: '55080300', name: 'เงินบริจาค', notes: '' },
            { code: '55080400', name: 'เงินช่วยเหลืออื่นๆ', notes: '' },
            { type: 'header', name: 'หมวด 58: ค่าใช้จ่ายด้านการผลิต' },
            { code: '53110700', name: 'ค่าวัสดุผลิต - ทั่วไป', notes: '' },
            { type: 'main_header', name: 'รวมงบประมาณรายจ่ายสินทรัพย์' },
            { type: 'header', name: 'หมวด 7 : สินทรัพย์ถาวร' },
            { code: '10', name: 'ครุภัณฑ์เครื่องใช้ไฟฟ้าและประปา', notes: '' },
            { code: '16', name: 'ครุภัณฑ์เบ็ดเตล็ด', notes: '' },
            { code: '25', name: 'ครุภัณฑ์ยานพาหนะและขนส่ง', notes: '' },
            { code: '5', name: 'ค่าเสริมสร้างปรับปรุงอาคารสถานที่', notes: '' },
        ];

        const defaultMasterRates = {
            '7': { position: 'ผู้บริหารส่วน', rent: 9500, monthlyAssist: 6250, lumpSum: 8000, travel: 300, local: 250, perDiem: 500, hotel: 2100 },
            '6': { position: 'ผู้บริหารทีม', rent: 9500, monthlyAssist: 6250, lumpSum: 8000, travel: 300, local: 250, perDiem: 500, hotel: 2100 },
            '5.5': { position: 'เจ้าหน้าที่ชำนาญงาน (ควบ)', rent: 9500, monthlyAssist: 6250, lumpSum: 6000, travel: 300, local: 250, perDiem: 500, hotel: 2100 },
            '5': { position: 'เจ้าหน้าที่ชำนาญงาน', rent: 8000, monthlyAssist: 5500, lumpSum: 6000, travel: 300, local: 250, perDiem: 450, hotel: 1800 },
            '4.5': { position: 'เจ้าหน้าที่ (ควบ)', rent: 8000, monthlyAssist: 5500, lumpSum: 6000, travel: 300, local: 250, perDiem: 450, hotel: 1800 },
            '4': { position: 'เจ้าหน้าที่', rent: 8000, monthlyAssist: 5500, lumpSum: 6000, travel: 300, local: 250, perDiem: 450, hotel: 1800 },
            '3': { position: 'พนักงานปฏิบัติการ', rent: 6500, monthlyAssist: 4750, lumpSum: 5000, travel: 300, local: 250, perDiem: 450, hotel: 1800 }
        };

        const defaultEmployees = [
            { id: '62539086', name: 'พัทธดนย์ ทรัพย์ประสม', gender: 'ชาย', startYear: 2539, level: '7', status: 'มีสิทธิ์', visitProvince: 'พิษณุโลก', homeVisitBusFare: 1200 },
            { id: '52531175', name: 'พีรนุช ธนบดีภัทร', gender: 'หญิง', startYear: 2531, level: '6', status: 'มีสิทธิ์', visitProvince: 'ขอนแก่น', homeVisitBusFare: 600 },
            { id: '82532130', name: 'นลินรัตน์ ตรีไพศาลศักดิ์', gender: 'หญิง', startYear: 2532, level: '5.5', status: 'มีสิทธิ์', visitProvince: 'ขอนแก่น', homeVisitBusFare: 0 },
            { id: '42538115', name: 'อุมารักษ์ เตลันยืน', gender: 'หญิง', startYear: 2538, level: '5', status: 'หมดสิทธิ์', visitProvince: '', homeVisitBusFare: 0 },
            { id: '42538092', name: 'สมควร กลิ่นสุคนธ์', gender: 'หญิง', startYear: 2538, level: '4', status: 'หมดสิทธิ์', visitProvince: '', homeVisitBusFare: 0 },
            { id: '52542046', name: 'สรวิชญ์ ธรรศเดชา', gender: 'ชาย', startYear: 2542, level: '5', status: 'มีสิทธิ์', visitProvince: '', homeVisitBusFare: 600 },
            { id: '22538173', name: 'ประภัสสร เล็กศรีสกุล', gender: 'หญิง', startYear: 2538, level: '5', status: 'มีสิทธิ์', visitProvince: 'ขอนแก่น', homeVisitBusFare: 600 },
            { id: '82542011', name: 'มลธิรา สุขสำราญ', gender: 'หญิง', startYear: 2542, level: '5', status: 'มีสิทธิ์', visitProvince: 'ขอนแก่น', homeVisitBusFare: 1200 },
            { id: '42539087', name: 'สุภาณี จำปานุ้ย', gender: 'หญิง', startYear: 2539, level: '5', status: 'มีสิทธิ์', visitProvince: 'ขอนแก่น', homeVisitBusFare: 600 },
            { id: '62537025', name: 'วิชญ อุปันนัทธ์', gender: 'ชาย', startYear: 2537, level: '5', status: 'มีสิทธิ์', visitProvince: 'เชียงใหม่', homeVisitBusFare: 600 },
            { id: '82536096', name: 'นุสรา อัศวโชคชัย', gender: 'หญิง', startYear: 2536, level: '5', status: 'มีสิทธิ์', visitProvince: 'ขอนแก่น', homeVisitBusFare: 600 },
            { id: '72539071', name: 'สันติภาพ ทองประดี', gender: 'ชาย', startYear: 2539, level: '5', status: 'มีสิทธิ์', visitProvince: 'ขอนแก่น', homeVisitBusFare: 0 },
            { id: '82538194', name: 'ขวัญญาณัฐ จุลเกษม', gender: 'หญิง', startYear: 2538, level: '4.5', status: 'มีสิทธิ์', visitProvince: 'ขอนแก่น', homeVisitBusFare: 600 },
            { id: '52538087', name: 'สงวน ร้องเกาะเกิด', gender: 'ชาย', startYear: 2538, level: '4', status: 'หมดสิทธิ์', visitProvince: '', homeVisitBusFare: 0 },
            { id: '2539140', name: 'สุมาพร จงภู่', gender: 'หญิง', startYear: 2539, level: '3', status: 'มีสิทธิ์', visitProvince: 'ขอนแก่น', homeVisitBusFare: 0 },
            { id: '42540033', name: 'คมสันติ์ นุชนารถ', gender: 'ชาย', startYear: 2540, level: '3', status: 'หมดสิทธิ์', visitProvince: '', homeVisitBusFare: 0 },
            { id: '82540031', name: 'พิชิต แจ่มศรี', gender: 'ชาย', startYear: 2540, level: '3', status: 'หมดสิทธิ์', visitProvince: '', homeVisitBusFare: 0 },
        ];

        const defaultSpecialAssist1Data = [
            { item: 'ควบคุมงานบำรุงรักษาระบบไฟฟ้าต้นกำลัง', timesPerYear: 1, days: 2, people: 1, rate: 250 },
            { item: 'ควบคุมงานบำรุงรักษาระบบรักษาความปลอดภัย', timesPerYear: 2, days: 2, people: 1, rate: 250 },
            { item: 'PM เครื่องจักร M7', timesPerYear: 12, days: 2, people: 1, rate: 250 },
            { item: 'Mini Overhaul เครื่อง M7', timesPerYear: 1, days: 2, people: 1, rate: 250 },
            { item: 'พนักงานทำงานผลิต', timesPerYear: 1, days: 242, people: 2, rate: 300 },
            { item: 'พนักงานควบคุมการตรวจจับวันเสาร์ อาทิตย์', timesPerYear: 1, days: 20, people: 1, rate: 300 },
            { item: 'ควบคุมงานล้างบ่อประปา', timesPerYear: 1, days: 2, people: 1, rate: 250 },
        ];

        const holidaysByYear = {
            2020: [
                { date: '2020-01-01', name: 'วันขึ้นปีใหม่' },
                { date: '2020-02-08', name: 'วันมาฆบูชา' },
                { date: '2020-04-06', name: 'วันจักรี' },
                { date: '2020-04-13', name: 'วันสงกรานต์' },
                { date: '2020-04-14', name: 'วันสงกรานต์' },
                { date: '2020-04-15', name: 'วันสงกรานต์' },
                { date: '2020-05-01', name: 'วันแรงงานแห่งชาติ' },
                { date: '2020-05-04', name: 'วันฉัตรมงคล' },
                { date: '2020-05-06', name: 'วันวิสาขบูชา' },
                { date: '2020-06-03', name: 'วันเฉลิมฯ พระราชินี' },
                { date: '2020-07-06', name: 'วันอาสาฬหบูชา' },
                { date: '2020-07-28', name: 'วันเฉลิมฯ ร.10' },
                { date: '2020-08-12', name: 'วันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' },
                { date: '2020-10-13', name: 'วันคล้ายวันสวรรคต ร.9' },
                { date: '2020-10-23', name: 'วันปิยมหาราช' },
                { date: '2020-12-05', name: 'วันคล้ายวันพระบรมราชสมภพ ร.9' },
                { date: '2020-12-10', name: 'วันรัฐธรรมนูญ' },
                { date: '2020-12-31', name: 'วันสิ้นปี' }
            ],
            2021: [
                { date: '2021-01-01', name: 'วันขึ้นปีใหม่' },
                { date: '2021-02-26', name: 'วันมาฆบูชา' },
                { date: '2021-04-06', name: 'วันจักรี' },
                { date: '2021-04-13', name: 'วันสงกรานต์' },
                { date: '2021-04-14', name: 'วันสงกรานต์' },
                { date: '2021-04-15', name: 'วันสงกรานต์' },
                { date: '2021-05-03', name: 'ชดเชยวันแรงงาน' },
                { date: '2021-05-04', name: 'วันฉัตรมงคล' },
                { date: '2021-05-26', name: 'วันวิสาขบูชา' },
                { date: '2021-06-03', name: 'วันเฉลิมฯ พระราชินี' },
                { date: '2021-07-26', name: 'ชดเชยวันอาสาฬหบูชา' },
                { date: '2021-07-28', name: 'วันเฉลิมฯ ร.10' },
                { date: '2021-08-12', name: 'วันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' },
                { date: '2021-10-13', name: 'วันคล้ายวันสวรรคต ร.9' },
                { date: '2021-10-25', name: 'ชดเชยวันปิยมหาราช' },
                { date: '2021-12-06', name: 'ชดเชยวันคล้ายวันพระบรมราชสมภพ ร.9' },
                { date: '2021-12-10', name: 'วันรัฐธรรมนูญ' },
                { date: '2021-12-31', name: 'วันสิ้นปี' }
            ],
            2022: [
                { date: '2022-01-03', name: 'ชดเชยวันขึ้นปีใหม่' },
                { date: '2022-02-16', name: 'วันมาฆบูชา' },
                { date: '2022-04-06', name: 'วันจักรี' },
                { date: '2022-04-13', name: 'วันสงกรานต์' },
                { date: '2022-04-14', name: 'วันสงกรานต์' },
                { date: '2022-04-15', name: 'วันสงกรานต์' },
                { date: '2022-05-02', name: 'ชดเชยวันแรงงาน' },
                { date: '2022-05-04', name: 'วันฉัตรมงคล' },
                { date: '2022-05-16', name: 'ชดเชยวันวิสาขบูชา' },
                { date: '2022-06-03', name: 'วันเฉลิมฯ พระราชินี' },
                { date: '2022-07-13', name: 'วันอาสาฬหบูชา' },
                { date: '2022-07-28', name: 'วันเฉลิมฯ ร.10' },
                { date: '2022-07-29', name: 'วันหยุดพิเศษ' },
                { date: '2022-08-12', name: 'วันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' },
                { date: '2022-10-13', name: 'วันคล้ายวันสวรรคต ร.9' },
                { date: '2022-10-14', name: 'วันหยุดพิเศษ' },
                { date: '2022-10-24', name: 'ชดเชยวันปิยมหาราช' },
                { date: '2022-12-05', name: 'วันคล้ายวันพระบรมราชสมภพ ร.9' },
                { date: '2022-12-12', name: 'ชดเชยวันรัฐธรรมนูญ' }
            ],
            2023: [
                { date: '2023-01-02', name: 'ชดเชยวันสิ้นปีและวันขึ้นปีใหม่' },
                { date: '2023-03-06', name: 'วันมาฆบูชา' },
                { date: '2023-04-06', name: 'วันจักรี' },
                { date: '2023-04-13', name: 'วันสงกรานต์' },
                { date: '2023-04-14', name: 'วันสงกรานต์' },
                { date: '2023-05-01', name: 'วันแรงงานแห่งชาติ' },
                { date: '2023-05-04', name: 'วันฉัตรมงคล' },
                { date: '2023-06-05', name: 'ชดเชยวันวิสาขบูชาและวันเฉลิมฯ พระราชินี' },
                { date: '2023-07-28', name: 'วันเฉลิมฯ ร.10' },
                { date: '2023-08-01', name: 'วันอาสาฬหบูชา' },
                { date: '2023-08-14', name: 'ชดเชยวันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' },
                { date: '2023-10-13', name: 'วันนวมินทรมหาราช' },
                { date: '2023-10-23', name: 'วันปิยมหาราช' },
                { date: '2023-12-05', name: 'วันคล้ายวันพระบรมราชสมภพ ร.9' },
                { date: '2023-12-11', name: 'ชดเชยวันรัฐธรรมนูญ' }
            ],
            2024: [
                { date: '2024-01-01', name: 'วันขึ้นปีใหม่' },
                { date: '2024-02-26', name: 'ชดเชยวันมาฆบูชา' },
                { date: '2024-04-08', name: 'ชดเชยวันจักรี' },
                { date: '2024-04-15', name: 'วันสงกรานต์' },
                { date: '2024-04-16', name: 'ชดเชยวันสงกรานต์' },
                { date: '2024-05-01', name: 'วันแรงงานแห่งชาติ' },
                { date: '2024-05-06', name: 'ชดเชยวันฉัตรมงคล' },
                { date: '2024-05-22', name: 'วันวิสาขบูชา' },
                { date: '2024-06-03', name: 'วันเฉลิมฯ พระราชินี' },
                { date: '2024-07-22', name: 'ชดเชยวันอาสาฬหบูชา' },
                { date: '2024-07-29', name: 'ชดเชยวันเฉลิมฯ ร.10' },
                { date: '2024-08-12', name: 'วันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' },
                { date: '2024-10-14', name: 'ชดเชยวันนวมินทรมหาราช' },
                { date: '2024-10-23', name: 'วันปิยมหาราช' },
                { date: '2024-12-05', name: 'วันคล้ายวันพระบรมราชสมภพ ร.9' },
                { date: '2024-12-10', name: 'วันรัฐธรรมนูญ' },
                { date: '2024-12-31', name: 'วันสิ้นปี' }
            ]
        };

        // Utility Functions
        const formatCurrency = (num) => {
            return new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        };

        const getRatesForEmployee = (employee, masterRates) => {
            const defaultRates = {
                position: 'ไม่ระบุ',
                rent: 0,
                monthlyAssist: 0,
                lumpSum: 0,
                travel: 0,
                local: 0,
                perDiem: 0,
                hotel: 0
            };
            
            const baseRates = masterRates[employee.level] || defaultRates;
            
            if (employee.customTravelRates) {
                return {
                    ...baseRates,
                    hotel: employee.customTravelRates.hotel ?? baseRates.hotel,
                    perDiem: employee.customTravelRates.perDiem ?? baseRates.perDiem,
                    travel: employee.customTravelRates.travel ?? baseRates.travel,
                    local: employee.customTravelRates.local ?? baseRates.local,
                };
            }
            
            return baseRates;
        };

        const calculateTravelEmployees = (employees, masterRates, calcYear) => {
            const eligibleServiceYears = [20, 25, 30, 35, 40];
            
            return employees
                .map(emp => ({ ...emp, serviceYears: calcYear - emp.startYear }))
                .filter(emp => eligibleServiceYears.includes(emp.serviceYears))
                .map(emp => {
                    const rates = getRatesForEmployee(emp, masterRates);
                    const hotelNights = 2;
                    const perDiemDays = 3;
                    const hotel = hotelNights * (rates.hotel || 0);
                    const perDiem = perDiemDays * (rates.perDiem || 0);
                    const travelRoundTrip = 2 * (rates.travel || 0);
                    const localRoundTrip = 2 * (rates.local || 0);
                    const total = hotel + perDiem + travelRoundTrip + localRoundTrip;
                    
                    return {
                        ...emp,
                        hotel,
                        perDiem,
                        travelRoundTrip,
                        localRoundTrip,
                        total,
                        hotelNights,
                        perDiemDays
                    };
                });
        };

        const calculateSpecialAssist = (employees, masterRates) => {
            return employees
                .filter(emp => emp.status === 'มีสิทธิ์')
                .map(emp => {
                    const rates = getRatesForEmployee(emp, masterRates);
                    const totalRent = (rates.rent || 0) * 12;
                    const totalMonthlyAssist = (rates.monthlyAssist || 0) * 12;
                    const lumpSum = rates.lumpSum || 0;
                    const total = totalRent + totalMonthlyAssist;
                    
                    return {
                        ...emp,
                        totalRent,
                        totalMonthlyAssist,
                        lumpSum,
                        total,
                        rentPerMonth: rates.rent || 0,
                        monthlyAssistPerMonth: rates.monthlyAssist || 0
                    };
                });
        };

        const calculateFamilyVisit = (employees) => {
            return employees.map(emp => {
                const busFareTotal = 4 * (emp.homeVisitBusFare || 0) * 2;
                return {
                    ...emp,
                    busFareTotal,
                    total: busFareTotal
                };
            });
        };

        const calculateWorkDays = (year, holidays = []) => {
            const yearCE = year - 543;
            let weekdays = 0;
            
            for (let m = 0; m < 12; m++) {
                const daysInMonth = new Date(yearCE, m + 1, 0).getDate();
                for (let d = 1; d <= daysInMonth; d++) {
                    const dayOfWeek = new Date(yearCE, m, d).getDay();
                    if (dayOfWeek > 0 && dayOfWeek < 6) {
                        weekdays++;
                    }
                }
            }
            
            let holidaysOnWeekdays = 0;
            holidays.forEach(holiday => {
                const date = new Date(holiday.date + 'T00:00:00');
                const dayOfWeek = date.getDay();
                if (dayOfWeek > 0 && dayOfWeek < 6) {
                    holidaysOnWeekdays++;
                }
            });
            
            return {
                weekdays,
                holidaysOnWeekdays,
                totalWorkDays: weekdays - holidaysOnWeekdays
            };
        };

        // UI Components
        const LoadingSpinner = () => {
            return (
                <div className="flex items-center justify-center min-h-[400px]">
                    <motion.div
                        className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full"
                        animate={{ rotate: 360 }}
                        transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
                    />
                </div>
            );
        };

        const Toast = ({ isVisible, message, type, onClose }) => {
            useEffect(() => {
                if (isVisible) {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }
            }, [isVisible, onClose]);

            const bgColor = type === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
            const textColor = type === 'success' ? 'text-green-800' : 'text-red-800';
            const Icon = type === 'success' ? CheckCircle : AlertCircle;
            const iconColor = type === 'success' ? 'text-green-600' : 'text-red-600';

            return (
                <AnimatePresence>
                    {isVisible && (
                        <motion.div
                            initial={{ opacity: 0, y: -50, scale: 0.9 }}
                            animate={{ opacity: 1, y: 0, scale: 1 }}
                            exit={{ opacity: 0, y: -50, scale: 0.9 }}
                            className={`fixed top-4 right-4 z-50 ${bgColor} border rounded-lg shadow-lg p-4 min-w-[300px] max-w-[500px]`}
                        >
                            <div className="flex items-center">
                                <Icon className={`w-5 h-5 mr-3 ${iconColor}`} />
                                <p className={`flex-1 text-sm font-medium ${textColor}`}>{message}</p>
                                <button
                                    onClick={onClose}
                                    className={`ml-3 p-1 hover:bg-opacity-20 hover:bg-gray-500 rounded transition-colors ${textColor}`}
                                >
                                    <X className="w-4 h-4" />
                                </button>
                            </div>
                        </motion.div>
                    )}
                </AnimatePresence>
            );
        };

        const Button = ({ 
            variant = 'primary', 
            size = 'md', 
            loading = false, 
            children, 
            className = '', 
            disabled, 
            ...props 
        }) => {
            const baseClasses = 'inline-flex items-center justify-center font-medium rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed';
            
            const variants = {
                primary: 'bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500',
                secondary: 'bg-gray-200 hover:bg-gray-300 text-gray-900 focus:ring-gray-500',
                success: 'bg-green-600 hover:bg-green-700 text-white focus:ring-green-500',
                danger: 'bg-red-600 hover:bg-red-700 text-white focus:ring-red-500',
                warning: 'bg-yellow-600 hover:bg-yellow-700 text-white focus:ring-yellow-500'
            };
            
            const sizes = {
                sm: 'px-3 py-1.5 text-sm',
                md: 'px-4 py-2 text-sm',
                lg: 'px-6 py-3 text-base'
            };

            return (
                <motion.button
                    whileHover={{ scale: 1.02 }}
                    whileTap={{ scale: 0.98 }}
                    className={`${baseClasses} ${variants[variant]} ${sizes[size]} ${className}`}
                    disabled={disabled || loading}
                    {...props}
                >
                    {loading ? (
                        <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            กำลังโหลด...
                        </>
                    ) : (
                        children
                    )}
                </motion.button>
            );
        };

        const Card = ({ children, className = '', hover = false }) => {
            return (
                <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.3 }}
                    whileHover={hover ? { y: -2, boxShadow: "0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)" } : undefined}
                    className={`bg-white rounded-xl shadow-lg overflow-hidden ${className}`}
                >
                    {children}
                </motion.div>
            );
        };

        // Tab Navigation Component
        const TabNavigation = ({ activeTab, onTabChange }) => {
            const tabs = [
                { id: 'dashboard', label: 'แดชบอร์ด', icon: React.createElement(Layout, { className: "w-4 h-4" }), category: 'main' },
                { id: 'budget', label: 'ตารางงบประมาณ', icon: React.createElement(Calculator, { className: "w-4 h-4" }), category: 'main' },
                { id: 'config', label: 'กำหนดข้อมูล', icon: React.createElement(Settings, { className: "w-4 h-4" }), category: 'main' },
                { id: 'travel', label: 'คำนวณค่าเดินทาง', icon: React.createElement(Car, { className: "w-4 h-4" }), category: 'calculation' },
                { id: 'special-assist', label: 'เงินช่วยเหลืออื่นๆ', icon: React.createElement(Heart, { className: "w-4 h-4" }), category: 'calculation' },
                { id: 'family-visit', label: 'เดินทางเยี่ยมครอบครัว', icon: React.createElement(Home, { className: "w-4 h-4" }), category: 'calculation' },
                { id: 'company-trip', label: 'เดินทางร่วมงานวันพนักงาน', icon: React.createElement(Users, { className: "w-4 h-4" }), category: 'calculation' },
                { id: 'manager-rotation', label: 'เดินทางหมุนเวียน ผจศ.', icon: React.createElement(RotateCcw, { className: "w-4 h-4" }), category: 'calculation' },
                { id: 'special-assist-1', label: 'เงินช่วยเหลือพิเศษ', icon: React.createElement(Banknote, { className: "w-4 h-4" }), category: 'calculation' },
                { id: 'overtime', label: 'ค่าล่วงเวลาทำงานวันหยุด', icon: React.createElement(Clock, { className: "w-4 h-4" }), category: 'calculation' },
                { id: 'workday-calc', label: 'คำนวณวันทำงาน', icon: React.createElement(Calendar, { className: "w-4 h-4" }), category: 'calculation' },
                { id: 'reports', label: 'รายงานและวิเคราะห์', icon: React.createElement(BarChart3, { className: "w-4 h-4" }), category: 'management' },
                { id: 'validation', label: 'ตรวจสอบข้อมูล', icon: React.createElement(Shield, { className: "w-4 h-4" }), category: 'management' },
                { id: 'backup', label: 'จัดการข้อมูลสำรอง', icon: React.createElement(Database, { className: "w-4 h-4" }), category: 'management' },
            ];

            const getCategoryColor = (category) => {
                switch (category) {
                    case 'main':
                        return 'border-blue-500 bg-blue-50';
                    case 'calculation':
                        return 'border-green-500 bg-green-50';
                    case 'management':
                        return 'border-purple-500 bg-purple-50';
                    default:
                        return 'border-gray-300 bg-gray-50';
                }
            };

            const getCategoryTitle = (category) => {
                switch (category) {
                    case 'main':
                        return 'หลัก';
                    case 'calculation':
                        return 'การคำนวณ';
                    case 'management':
                        return 'จัดการ';
                    default:
                        return '';
                }
            };

            const groupedTabs = tabs.reduce((acc, tab) => {
                const category = tab.category || 'main';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(tab);
                return acc;
            }, {});

            return (
                <div className="mb-8 bg-white rounded-xl shadow-sm overflow-hidden">
                    {Object.entries(groupedTabs).map(([category, categoryTabs]) => (
                        <div key={category} className="border-b border-gray-100 last:border-b-0">
                            <div className={`px-4 py-2 text-xs font-semibold text-gray-600 uppercase tracking-wider ${getCategoryColor(category)}`}>
                                {getCategoryTitle(category)}
                            </div>
                            <nav className="flex flex-wrap" aria-label="Tabs">
                                {categoryTabs.map((tab) => (
                                    <button
                                        key={tab.id}
                                        onClick={() => onTabChange(tab.id)}
                                        className={`relative flex items-center whitespace-nowrap py-3 px-4 text-sm font-medium transition-all duration-200 hover:text-blue-600 hover:bg-gray-50 ${
                                            activeTab === tab.id
                                                ? 'text-blue-600 bg-blue-50 border-b-2 border-blue-600'
                                                : 'text-gray-600'
                                        }`}
                                    >
                                        {tab.icon}
                                        <span className="ml-2">{tab.label}</span>
                                        {activeTab === tab.id && (
                                            <motion.div
                                                layoutId="activeTab"
                                                className="absolute bottom-0 left-0 right-0 h-0.5 bg-blue-600"
                                                initial={false}
                                                transition={{ type: "spring", stiffness: 500, damping: 30 }}
                                            />
                                        )}
                                    </button>
                                ))}
                            </nav>
                        </div>
                    ))}
                </div>
            );
        };

        // Dashboard Component
        const Dashboard = ({ budgetData, employees, currentYear, nextYear, onNavigate }) => {
            const budgetSummary = budgetData
                .filter(item => !item.type && item.values)
                .reduce((acc, item) => {
                    const current = item.values[currentYear] || 0;
                    const next = item.values[nextYear] || 0;
                    return {
                        current: acc.current + current,
                        next: acc.next + next,
                        difference: acc.difference + (next - current)
                    };
                }, { current: 0, next: 0, difference: 0 });

            const employeeStats = {
                total: employees.length,
                byLevel: employees.reduce((acc, emp) => {
                    acc[emp.level] = (acc[emp.level] || 0) + 1;
                    return acc;
                }, {}),
                withVisitProvince: employees.filter(emp => 
                    emp.visitProvince && emp.visitProvince.trim() !== '' && emp.visitProvince !== 'ขอนแก่น'
                ).length,
                eligible: employees.filter(emp => emp.status === 'มีสิทธิ์').length
            };

            const quickActions = [
                {
                    title: 'จัดการข้อมูลพนักงาน',
                    description: 'เพิ่ม แก้ไข หรือลบข้อมูลพนักงาน',
                    icon: React.createElement(Users, { className: "w-6 h-6" }),
                    color: 'bg-blue-500',
                    action: () => onNavigate('config')
                },
                {
                    title: 'คำนวณค่าเดินทาง',
                    description: 'คำนวณค่าเดินทางรับของที่ระลึก',
                    icon: React.createElement(Calculator, { className: "w-6 h-6" }),
                    color: 'bg-green-500',
                    action: () => onNavigate('travel')
                },
                {
                    title: 'จัดทำงบประมาณ',
                    description: 'ดูและแก้ไขตารางงบประมาณ',
                    icon: React.createElement(FileText, { className: "w-6 h-6" }),
                    color: 'bg-purple-500',
                    action: () => onNavigate('budget')
                },
                {
                    title: 'คำนวณวันทำงาน',
                    description: 'จัดการวันหยุดและคำนวณวันทำงาน',
                    icon: React.createElement(Clock, { className: "w-6 h-6" }),
                    color: 'bg-orange-500',
                    action: () => onNavigate('workday-calc')
                }
            ];

            const containerVariants = {
                hidden: { opacity: 0 },
                visible: {
                    opacity: 1,
                    transition: {
                        staggerChildren: 0.1
                    }
                }
            };

            const itemVariants = {
                hidden: { opacity: 0, y: 20 },
                visible: { opacity: 1, y: 0 }
            };

            return (
                <motion.div
                    variants={containerVariants}
                    initial="hidden"
                    animate="visible"
                    className="space-y-8"
                >
                    <motion.div variants={itemVariants} className="text-center">
                        <h2 className="text-3xl font-bold text-gray-900 mb-2">แดชบอร์ดภาพรวม</h2>
                        <p className="text-gray-600">สรุปข้อมูลสำคัญและการดำเนินงานของระบบ</p>
                    </motion.div>

                    <motion.div variants={itemVariants} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <Card className="p-6 bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-blue-600 text-sm font-medium">งบประมาณปี {nextYear}</p>
                                    <p className="text-2xl font-bold text-blue-900">{formatCurrency(budgetSummary.next)}</p>
                                </div>
                                <div className="p-3 bg-blue-500 rounded-full">
                                    <TrendingUp className="w-6 h-6 text-white" />
                                </div>
                            </div>
                            <div className="mt-4">
                                <div className={`flex items-center text-sm ${
                                    budgetSummary.difference >= 0 ? 'text-green-600' : 'text-red-600'
                                }`}>
                                    {budgetSummary.difference >= 0 ? '↗' : '↘'} {formatCurrency(Math.abs(budgetSummary.difference))}
                                    <span className="ml-1">จากปีก่อน</span>
                                </div>
                            </div>
                        </Card>

                        <Card className="p-6 bg-gradient-to-br from-green-50 to-green-100 border-green-200">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-green-600 text-sm font-medium">จำนวนพนักงาน</p>
                                    <p className="text-2xl font-bold text-green-900">{employeeStats.total} คน</p>
                                </div>
                                <div className="p-3 bg-green-500 rounded-full">
                                    <Users className="w-6 h-6 text-white" />
                                </div>
                            </div>
                            <div className="mt-4">
                                <div className="text-sm text-green-600">
                                    มีสิทธิ์ {employeeStats.eligible} คน • อื่นๆ {employeeStats.total - employeeStats.eligible} คน
                                </div>
                            </div>
                        </Card>

                        <Card className="p-6 bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-purple-600 text-sm font-medium">มีสิทธิ์เงินช่วยเหลือ</p>
                                    <p className="text-2xl font-bold text-purple-900">{employeeStats.withVisitProvince} คน</p>
                                </div>
                                <div className="p-3 bg-purple-500 rounded-full">
                                    <Target className="w-6 h-6 text-white" />
                                </div>
                            </div>
                            <div className="mt-4">
                                <div className="text-sm text-purple-600">
                                    {Math.round((employeeStats.withVisitProvince / employeeStats.total) * 100)}% ของพนักงานทั้งหมด
                                </div>
                            </div>
                        </Card>

                        <Card className="p-6 bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-orange-600 text-sm font-medium">สถานะระบบ</p>
                                    <p className="text-lg font-bold text-orange-900 flex items-center">
                                        <CheckCircle className="w-5 h-5 mr-2 text-green-500" />
                                        พร้อมใช้งาน
                                    </p>
                                </div>
                                <div className="p-3 bg-orange-500 rounded-full">
                                    <BarChart3 className="w-6 h-6 text-white" />
                                </div>
                            </div>
                            <div className="mt-4">
                                <div className="text-sm text-orange-600">
                                    ข้อมูลอัปเดตล่าสุด
                                </div>
                            </div>
                        </Card>
                    </motion.div>

                    <motion.div variants={itemVariants}>
                        <h3 className="text-xl font-semibold text-gray-900 mb-4">การดำเนินการด่วน</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            {quickActions.map((action, index) => (
                                <Card key={index} className="p-6 hover:shadow-lg transition-shadow cursor-pointer" hover>
                                    <div className="text-center" onClick={action.action}>
                                        <div className={`inline-flex p-3 rounded-full ${action.color} mb-4`}>
                                            {React.cloneElement(action.icon, { className: 'w-6 h-6 text-white' })}
                                        </div>
                                        <h4 className="font-semibold text-gray-900 mb-2">{action.title}</h4>
                                        <p className="text-sm text-gray-600">{action.description}</p>
                                    </div>
                                </Card>
                            ))}
                        </div>
                    </motion.div>

                    <motion.div variants={itemVariants} className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <Card className="p-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <PieChart className="w-5 h-5 mr-2" />
                                การกระจายตัวพนักงานตามระดับ
                            </h3>
                            <div className="space-y-3">
                                {Object.entries(employeeStats.byLevel)
                                    .sort(([a], [b]) => {
                                        if (a === 'ท้องถิ่น') return 1;
                                        if (b === 'ท้องถิ่น') return -1;
                                        return parseFloat(b) - parseFloat(a);
                                    })
                                    .map(([level, count]) => {
                                        const percentage = Math.round((count / employeeStats.total) * 100);
                                        return (
                                            <div key={level} className="flex items-center justify-between">
                                                <div className="flex items-center">
                                                    <div className="w-4 h-4 bg-blue-500 rounded mr-3"></div>
                                                    <span className="font-medium">ระดับ {level}</span>
                                                </div>
                                                <div className="text-right">
                                                    <span className="font-bold">{count} คน</span>
                                                    <span className="text-gray-500 ml-2">({percentage}%)</span>
                                                </div>
                                            </div>
                                        );
                                    })}
                            </div>
                        </Card>

                        <Card className="p-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <BarChart3 className="w-5 h-5 mr-2" />
                                สรุปงบประมาณ
                            </h3>
                            <div className="space-y-4">
                                <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span className="font-medium">งบประมาณปี {currentYear}</span>
                                    <span className="font-bold text-blue-600">{formatCurrency(budgetSummary.current)}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span className="font-medium">คำของบประมาณปี {nextYear}</span>
                                    <span className="font-bold text-green-600">{formatCurrency(budgetSummary.next)}</span>
                                </div>
                                <div className={`flex justify-between items-center p-3 rounded-lg ${
                                    budgetSummary.difference >= 0 ? 'bg-green-50' : 'bg-red-50'
                                }`}>
                                    <span className="font-medium">ผลต่าง</span>
                                    <span className={`font-bold ${
                                        budgetSummary.difference >= 0 ? 'text-green-600' : 'text-red-600'
                                    }`}>
                                        {budgetSummary.difference >= 0 ? '+' : ''}{formatCurrency(budgetSummary.difference)}
                                    </span>
                                </div>
                            </div>
                        </Card>
                    </motion.div>

                    <motion.div variants={itemVariants}>
                        <Card className="p-6 bg-gradient-to-r from-green-50 to-blue-50 border-green-200">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center">
                                    <CheckCircle className="w-8 h-8 text-green-500 mr-4" />
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900">ระบบพร้อมใช้งาน</h3>
                                        <p className="text-gray-600">ข้อมูลทั้งหมดถูกบันทึกในเครื่องของคุณอย่างปลอดภัย</p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <p className="text-sm text-gray-500">อัปเดตล่าสุด</p>
                                    <p className="font-medium">{new Date().toLocaleDateString('th-TH')}</p>
                                </div>
                            </div>
                        </Card>
                    </motion.div>
                </motion.div>
            );
        };

        // Budget Table Component
        const BudgetTable = ({ budgetData, currentYear, nextYear, onUpdateBudget, onUpdateNotes }) => {
            const calculateTotals = () => {
                const totalCurrent = budgetData.reduce((sum, item) => 
                    sum + (item.values ? (item.values[currentYear] || 0) : 0), 0
                );
                const totalNext = budgetData.reduce((sum, item) => 
                    sum + (item.values ? (item.values[nextYear] || 0) : 0), 0
                );
                const totalDiff = totalNext - totalCurrent;
                
                return { totalCurrent, totalNext, totalDiff };
            };

            const { totalCurrent, totalNext, totalDiff } = calculateTotals();
            const diffClass = totalDiff > 0 ? "text-green-600" : totalDiff < 0 ? "text-red-600" : "text-gray-500";

            return (
                <Card>
                    <div className="overflow-x-auto">
                        <table className="w-full min-w-[1000px] text-sm text-left text-gray-700">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th className="px-6 py-4 w-1/12">รหัสบัญชี</th>
                                    <th className="px-6 py-4 w-4/12">รายการ</th>
                                    <th className="px-6 py-4 w-2/12 text-center">งบประมาณปี {currentYear}</th>
                                    <th className="px-6 py-4 w-2/12 text-center">คำของบประมาณปี {nextYear}</th>
                                    <th className="px-6 py-4 w-1/12 text-right">ผลต่าง (+/-)</th>
                                    <th className="px-6 py-4 w-2/12 text-center">หมายเหตุ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {budgetData.map((item, index) => {
                                    if (item.type) {
                                        const headerClass = item.type === 'main_header' 
                                            ? "bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold text-base" 
                                            : "bg-gradient-to-r from-blue-50 to-blue-100 font-semibold text-blue-800";
                                        
                                        return (
                                            <tr key={index} className={headerClass}>
                                                <td colSpan={6} className="px-6 py-4">{item.name}</td>
                                            </tr>
                                        );
                                    }

                                    const currentValue = item.values?.[currentYear] || 0;
                                    const nextValue = item.values?.[nextYear] || 0;
                                    const diff = nextValue - currentValue;
                                    const diffClass = diff > 0 ? "text-green-600" : diff < 0 ? "text-red-600" : "text-gray-500";

                                    return (
                                        <tr key={index} className="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                                            <td className="px-6 py-3 font-mono text-sm">{item.code}</td>
                                            <td className="px-6 py-3 font-medium">{item.name}</td>
                                            <td className="px-6 py-3">
                                                <input
                                                    type="number"
                                                    className="w-full p-2 text-right bg-white border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                    value={currentValue}
                                                    onChange={(e) => onUpdateBudget(index, currentYear, parseFloat(e.target.value) || 0)}
                                                />
                                            </td>
                                            <td className="px-6 py-3">
                                                <input
                                                    type="number"
                                                    className="w-full p-2 text-right bg-white border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                    value={nextValue}
                                                    onChange={(e) => onUpdateBudget(index, nextYear, parseFloat(e.target.value) || 0)}
                                                />
                                            </td>
                                            <td className={`px-6 py-3 text-right font-medium ${diffClass}`}>
                                                {formatCurrency(diff)}
                                            </td>
                                            <td className="px-6 py-3">
                                                <input
                                                    type="text"
                                                    className="w-full p-2 bg-white border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                    value={item.notes || ''}
                                                    onChange={(e) => onUpdateNotes(index, e.target.value)}
                                                />
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                            <tfoot className="font-bold bg-gradient-to-r from-gray-100 to-gray-200 sticky bottom-0">
                                <tr className="border-t-2 border-gray-300">
                                    <td colSpan={2} className="px-6 py-4 text-lg">ยอดรวมทั้งหมด</td>
                                    <td className="px-6 py-4 text-right text-lg">{formatCurrency(totalCurrent)}</td>
                                    <td className="px-6 py-4 text-right text-lg">{formatCurrency(totalNext)}</td>
                                    <td className={`px-6 py-4 text-right text-lg font-bold ${diffClass}`}>
                                        {formatCurrency(totalDiff)}
                                    </td>
                                    <td className="px-6 py-4"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </Card>
            );
        };

        // Employee Table Component
        const EmployeeTable = ({ 
            employees, 
            masterRates, 
            selectedTravelEmployees, 
            onUpdateEmployee, 
            onAddEmployee, 
            onDeleteEmployee, 
            onUpdateSelection 
        }) => {
            const [attachedDocuments, setAttachedDocuments] = useState([]);

            const updateEmployeeField = (index, field, value) => {
                const employee = employees[index];
                const updatedEmployee = { ...employee, [field]: value };
                onUpdateEmployee(index, updatedEmployee);
            };

            const levelOptions = Object.keys(masterRates).sort((a, b) => parseFloat(b) - parseFloat(a));

            const handleSelectionChange = (employeeId, isSelected) => {
                let newSelection;
                if (isSelected) {
                    newSelection = [...selectedTravelEmployees, employeeId];
                } else {
                    newSelection = selectedTravelEmployees.filter(id => id !== employeeId);
                }
                
                onUpdateSelection('travel', newSelection);
                onUpdateSelection('special-assist', newSelection);
                onUpdateSelection('family-visit', newSelection);
                onUpdateSelection('company-trip', newSelection);
                onUpdateSelection('manager-rotation', newSelection);
            };

            const handleSelectAll = () => {
                const allEmployeeIds = employees.map(emp => emp.id);
                onUpdateSelection('travel', allEmployeeIds);
                onUpdateSelection('special-assist', allEmployeeIds);
                onUpdateSelection('family-visit', allEmployeeIds);
                onUpdateSelection('company-trip', allEmployeeIds);
                onUpdateSelection('manager-rotation', allEmployeeIds);
            };

            const handleSelectNone = () => {
                onUpdateSelection('travel', []);
                onUpdateSelection('special-assist', []);
                onUpdateSelection('family-visit', []);
                onUpdateSelection('company-trip', []);
                onUpdateSelection('manager-rotation', []);
            };

            const isEmployeeSelected = (employeeId) => {
                return selectedTravelEmployees.includes(employeeId);
            };

            const handlePdfUpload = (event) => {
                const file = event.target.files?.[0];
                if (file && file.type === 'application/pdf') {
                    const url = URL.createObjectURL(file);
                    const newDoc = {
                        name: file.name,
                        url: url,
                        uploadDate: new Date()
                    };
                    setAttachedDocuments(prev => [...prev, newDoc]);
                    window.open(url, '_blank');
                } else {
                    alert('กรุณาเลือกไฟล์ PDF เท่านั้น');
                }
                event.target.value = '';
            };

            const removeDocument = (index) => {
                setAttachedDocuments(prev => {
                    const doc = prev[index];
                    URL.revokeObjectURL(doc.url);
                    return prev.filter((_, i) => i !== index);
                });
            };

            const openDocument = (url) => {
                window.open(url, '_blank');
            };

            return (
                <div className="space-y-6">
                    <Card>
                        <div className="p-6 border-b border-gray-200">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-semibold text-gray-900">รายชื่อพนักงาน</h3>
                                <div className="flex gap-3">
                                    <div className="relative">
                                        <input
                                            type="file"
                                            accept=".pdf"
                                            onChange={handlePdfUpload}
                                            className="hidden"
                                            id="pdf-upload"
                                        />
                                        <Button
                                            onClick={() => document.getElementById('pdf-upload')?.click()}
                                            variant="secondary"
                                            size="sm"
                                        >
                                            <FileText className="w-4 h-4 mr-2" />
                                            แนบระเบียบ PDF
                                        </Button>
                                    </div>
                                    <Button onClick={onAddEmployee} size="sm">
                                        <Plus className="w-4 h-4 mr-2" />
                                        เพิ่มพนักงาน
                                    </Button>
                                </div>
                            </div>

                            <div className="bg-blue-50 border-2 border-blue-200 p-4 rounded-lg">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <h5 className="font-semibold text-blue-700 text-lg flex items-center">
                                            <UserCheck className="w-5 h-5 mr-2" />
                                            เลือกพนักงานสำหรับการคำนวณ
                                        </h5>
                                        <p className="text-sm text-blue-700 opacity-80">
                                            เลือกแล้ว {selectedTravelEmployees.length} คน จากทั้งหมด {employees.length} คน
                                            (ใช้สำหรับการคำนวณทุกประเภท)
                                        </p>
                                    </div>
                                    <div className="flex gap-2">
                                        <Button
                                            variant="secondary"
                                            size="sm"
                                            onClick={handleSelectAll}
                                            disabled={selectedTravelEmployees.length === employees.length}
                                        >
                                            <UserCheck className="w-4 h-4 mr-1" />
                                            เลือกทั้งหมด
                                        </Button>
                                        <Button
                                            variant="secondary"
                                            size="sm"
                                            onClick={handleSelectNone}
                                            disabled={selectedTravelEmployees.length === 0}
                                        >
                                            <UserX className="w-4 h-4 mr-1" />
                                            ยกเลิกทั้งหมด
                                        </Button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 w-16 text-center">
                                            <div className="flex items-center justify-center">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedTravelEmployees.length === employees.length && employees.length > 0}
                                                    onChange={(e) => e.target.checked ? handleSelectAll() : handleSelectNone()}
                                                    className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                                />
                                            </div>
                                        </th>
                                        <th className="px-4 py-3">รหัสพนักงาน</th>
                                        <th className="px-4 py-3">ชื่อ-สกุล</th>
                                        <th className="px-4 py-3 text-center">เพศ</th>
                                        <th className="px-4 py-3">ปีเริ่มงาน</th>
                                        <th className="px-4 py-3">ระดับ</th>
                                        <th className="px-4 py-3 text-center">สถานะ</th>
                                        <th className="px-4 py-3">จังหวัดเยี่ยมบ้าน</th>
                                        <th className="px-4 py-3 text-right">ค่ารถทัวร์เยี่ยมบ้าน</th>
                                        <th className="px-4 py-3 text-center">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {employees.length === 0 ? (
                                        <tr>
                                            <td colSpan={10} className="text-center text-gray-500 py-8">
                                                ไม่มีข้อมูลพนักงาน
                                            </td>
                                        </tr>
                                    ) : (
                                        employees.map((emp, index) => (
                                            <tr key={index} className={`border-b border-gray-200 transition-colors ${
                                                isEmployeeSelected(emp.id) ? 'bg-blue-50 hover:bg-blue-100' : 'hover:bg-gray-50'
                                            }`}>
                                                <td className="px-4 py-3 text-center">
                                                    <input
                                                        type="checkbox"
                                                        checked={isEmployeeSelected(emp.id)}
                                                        onChange={(e) => handleSelectionChange(emp.id, e.target.checked)}
                                                        className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <input
                                                        type="text"
                                                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        value={emp.id}
                                                        onChange={(e) => updateEmployeeField(index, 'id', e.target.value)}
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <input
                                                        type="text"
                                                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        value={emp.name}
                                                        onChange={(e) => updateEmployeeField(index, 'name', e.target.value)}
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <div className="flex justify-center gap-2">
                                                        <button
                                                            type="button"
                                                            onClick={() => updateEmployeeField(index, 'gender', 'ชาย')}
                                                            className={`p-2 rounded-lg border-2 transition-colors ${
                                                                emp.gender === 'ชาย' 
                                                                    ? 'border-blue-500 bg-blue-50 text-blue-700' 
                                                                    : 'border-gray-300 bg-white text-gray-500 hover:border-blue-300'
                                                            }`}
                                                            title="ชาย"
                                                        >
                                                            ♂
                                                        </button>
                                                        <button
                                                            type="button"
                                                            onClick={() => updateEmployeeField(index, 'gender', 'หญิง')}
                                                            className={`p-2 rounded-lg border-2 transition-colors ${
                                                                emp.gender === 'หญิง' 
                                                                    ? 'border-pink-500 bg-pink-50 text-pink-700' 
                                                                    : 'border-gray-300 bg-white text-gray-500 hover:border-pink-300'
                                                            }`}
                                                            title="หญิง"
                                                        >
                                                            ♀
                                                        </button>
                                                    </div>
                                                </td>
                                                <td className="p-3">
                                                    <input
                                                        type="number"
                                                        className="w-full p-2 border border-gray-300 rounded-md text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        value={emp.startYear}
                                                        onChange={(e) => updateEmployeeField(index, 'startYear', parseInt(e.target.value) || 0)}
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <select
                                                        className="w-full p-2 border border-gray-300 rounded-md bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        value={emp.level}
                                                        onChange={(e) => updateEmployeeField(index, 'level', e.target.value)}
                                                    >
                                                        {levelOptions.map(level => (
                                                            <option key={level} value={level}>{level}</option>
                                                        ))}
                                                    </select>
                                                </td>
                                                <td className="p-3">
                                                    <div className="flex justify-center gap-2">
                                                        <button
                                                            type="button"
                                                            onClick={() => updateEmployeeField(index, 'status', 'มีสิทธิ์')}
                                                            className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                                                                emp.status === 'มีสิทธิ์' || !emp.status
                                                                    ? 'bg-green-100 text-green-800 border border-green-300' 
                                                                    : 'bg-gray-100 text-gray-600 border border-gray-300 hover:bg-green-50'
                                                            }`}
                                                        >
                                                            มีสิทธิ์
                                                        </button>
                                                        <button
                                                            type="button"
                                                            onClick={() => updateEmployeeField(index, 'status', 'หมดสิทธิ์')}
                                                            className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                                                                emp.status === 'หมดสิทธิ์'
                                                                    ? 'bg-red-100 text-red-800 border border-red-300' 
                                                                    : 'bg-gray-100 text-gray-600 border border-gray-300 hover:bg-red-50'
                                                            }`}
                                                        >
                                                            หมดสิทธิ์
                                                        </button>
                                                    </div>
                                                </td>
                                                <td className="p-3">
                                                    <input
                                                        type="text"
                                                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        value={emp.visitProvince}
                                                        onChange={(e) => updateEmployeeField(index, 'visitProvince', e.target.value)}
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <input
                                                        type="number"
                                                        className="w-full p-2 border border-gray-300 rounded-md text-right focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        value={emp.homeVisitBusFare}
                                                        onChange={(e) => updateEmployeeField(index, 'homeVisitBusFare', parseFloat(e.target.value) || 0)}
                                                    />
                                                </td>
                                                <td className="p-3 text-center">
                                                    <Button
                                                        variant="danger"
                                                        size="sm"
                                                        onClick={() => onDeleteEmployee(index)}
                                                    >
                                                        <Trash2 className="w-4 h-4" />
                                                    </Button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    <Card>
                        <div className="p-6 border-b border-gray-200">
                            <h3 className="text-xl font-semibold text-gray-900 flex items-center">
                                <FileText className="w-5 h-5 mr-2" />
                                เอกสารที่แนบ
                            </h3>
                            <p className="text-sm text-gray-600 mt-1">
                                เอกสารระเบียบและไฟล์ที่เกี่ยวข้องกับการจัดการพนักงาน
                            </p>
                        </div>
                        
                        <div className="p-6">
                            {attachedDocuments.length === 0 ? (
                                <div className="text-center py-8">
                                    <FileText className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                                    <p className="text-gray-500">ยังไม่มีเอกสารที่แนบ</p>
                                    <p className="text-sm text-gray-400 mt-1">
                                        ใช้ปุ่ม "แนบระเบียบ PDF" ด้านบนเพื่อเพิ่มเอกสาร
                                    </p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {attachedDocuments.map((doc, index) => (
                                        <div key={index} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                            <div className="flex items-start justify-between">
                                                <div className="flex items-start space-x-3 flex-1">
                                                    <div className="p-2 bg-red-100 rounded-lg">
                                                        <FileText className="w-5 h-5 text-red-600" />
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <h4 className="font-medium text-gray-900 truncate" title={doc.name}>
                                                            {doc.name}
                                                        </h4>
                                                        <p className="text-sm text-gray-500">
                                                            แนบเมื่อ: {doc.uploadDate.toLocaleDateString('th-TH')}
                                                        </p>
                                                        <div className="flex gap-2 mt-2">
                                                            <Button
                                                                size="sm"
                                                                variant="secondary"
                                                                onClick={() => openDocument(doc.url)}
                                                            >
                                                                เปิดดู
                                                            </Button>
                                                            <Button
                                                                size="sm"
                                                                variant="danger"
                                                                onClick={() => removeDocument(index)}
                                                            >
                                                                ลบ
                                                            </Button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </Card>
                </div>
            );
        };

        // Travel Calculation Table Component
        const TravelCalculationTable = ({ 
            employees, 
            masterRates, 
            selectedEmployeeIds, 
            calcYear, 
            onSave, 
            onUpdateEmployee 
        }) => {
            const [editingValues, setEditingValues] = useState({});
            const [editMode, setEditMode] = useState({});
            const [currentCalcYear, setCurrentCalcYear] = useState(calcYear);
            const [customDays, setCustomDays] = useState({ hotelNights: 2, perDiemDays: 3 });

            const selectedEmployees = employees.filter(emp => selectedEmployeeIds.includes(emp.id));
            const travelEmployees = calculateTravelEmployees(selectedEmployees, masterRates, currentCalcYear);
            
            const stats = {
                totalEmployees: selectedEmployees.length,
                eligibleEmployees: travelEmployees.length,
                totalCost: travelEmployees.reduce((sum, emp) => {
                    const rates = getRatesForEmployee(emp, masterRates);
                    const hotel = customDays.hotelNights * (rates.hotel || 0);
                    const perDiem = customDays.perDiemDays * (rates.perDiem || 0);
                    const travelRoundTrip = 2 * (rates.travel || 0);
                    const localRoundTrip = 2 * (rates.local || 0);
                    return sum + hotel + perDiem + travelRoundTrip + localRoundTrip;
                }, 0),
                byServiceYears: travelEmployees.reduce((acc, emp) => {
                    acc[emp.serviceYears] = (acc[emp.serviceYears] || 0) + 1;
                    return acc;
                }, {})
            };

            const handleDaysEditStart = (field, currentValue) => {
                setEditingValues(prev => ({ ...prev, [field]: currentValue }));
                setEditMode(prev => ({ ...prev, [field]: true }));
            };

            const handleDaysEditSave = (field) => {
                const newValue = editingValues[field];
                if (newValue !== undefined) {
                    setCustomDays(prev => ({ ...prev, [field]: parseInt(newValue) || 0 }));
                }
                setEditMode(prev => ({ ...prev, [field]: false }));
                setEditingValues(prev => ({ ...prev, [field]: undefined }));
            };

            const handleDaysEditCancel = (field) => {
                setEditMode(prev => ({ ...prev, [field]: false }));
                setEditingValues(prev => ({ ...prev, [field]: undefined }));
            };

            const renderEditableDays = (field, currentValue, label) => {
                const isEditing = editMode[field];
                
                if (isEditing) {
                    return (
                        <div className="flex items-center gap-2">
                            <input
                                type="number"
                                min="1"
                                max="10"
                                className="w-16 p-2 text-center border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                value={editingValues[field] || currentValue}
                                onChange={(e) => setEditingValues(prev => ({ ...prev, [field]: parseInt(e.target.value) || 0 }))}
                                autoFocus
                            />
                            <Button
                                size="sm"
                                onClick={() => handleDaysEditSave(field)}
                                className="p-1 h-7 w-7"
                            >
                                <Check className="w-3 h-3" />
                            </Button>
                            <Button
                                variant="secondary"
                                size="sm"
                                onClick={() => handleDaysEditCancel(field)}
                                className="p-1 h-7 w-7"
                            >
                                <X className="w-3 h-3" />
                            </Button>
                        </div>
                    );
                }

                return (
                    <div className="flex items-center gap-2 group">
                        <span className="font-bold text-blue-600 text-lg">{currentValue}</span>
                        <Button
                            variant="secondary"
                            size="sm"
                            onClick={() => handleDaysEditStart(field, currentValue)}
                            className="p-1 h-6 w-6 opacity-0 group-hover:opacity-50 hover:opacity-100 transition-opacity"
                            title={`แก้ไข${label}`}
                        >
                            <Edit3 className="w-3 h-3" />
                        </Button>
                    </div>
                );
            };

            return (
                <Card>
                    <div className="p-6 border-b border-gray-200">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-semibold text-gray-900">
                                สรุปค่าใช้จ่ายเดินทางเพื่อรับของที่ระลึก
                            </h3>
                            <div className="flex items-center gap-4">
                                <Button
                                    variant="secondary"
                                    size="sm"
                                    onClick={() => setCurrentCalcYear(prev => prev - 1)}
                                >
                                    <ChevronLeft className="w-4 h-4 mr-1" />
                                    ปีก่อนหน้า
                                </Button>
                                <div className="text-center px-4 py-2 bg-blue-50 rounded-lg border border-blue-200">
                                    <div className="text-sm text-blue-600">คำนวณสำหรับปี พ.ศ.</div>
                                    <div className="text-xl font-bold text-blue-900">{currentCalcYear}</div>
                                </div>
                                <Button
                                    variant="secondary"
                                    size="sm"
                                    onClick={() => setCurrentCalcYear(prev => prev + 1)}
                                >
                                    ปีถัดไป
                                    <ChevronRight className="w-4 h-4 ml-1" />
                                </Button>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-blue-600 text-sm font-medium">พนักงานที่เลือก</p>
                                        <p className="text-2xl font-bold text-blue-900">{stats.totalEmployees}</p>
                                    </div>
                                    <Users className="w-8 h-8 text-blue-500" />
                                </div>
                            </div>
                            
                            <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-green-600 text-sm font-medium">มีสิทธิ์รับของ</p>
                                        <p className="text-2xl font-bold text-green-900">{stats.eligibleEmployees}</p>
                                    </div>
                                    <Award className="w-8 h-8 text-green-500" />
                                </div>
                            </div>
                            
                            <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-purple-600 text-sm font-medium">ปีคำนวณ</p>
                                        <p className="text-2xl font-bold text-purple-900">{currentCalcYear}</p>
                                    </div>
                                    <Calendar className="w-8 h-8 text-purple-500" />
                                </div>
                            </div>
                            
                            <div className="bg-orange-50 p-4 rounded-lg border border-orange-200">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-orange-600 text-sm font-medium">ยอดรวม</p>
                                        <p className="text-lg font-bold text-orange-900">{formatCurrency(stats.totalCost)}</p>
                                    </div>
                                    <Calculator className="w-8 h-8 text-orange-500" />
                                </div>
                            </div>
                        </div>

                        {Object.keys(stats.byServiceYears).length > 0 && (
                            <div className="bg-green-50 p-4 rounded-lg mb-6 border border-green-200">
                                <h5 className="font-semibold text-green-800 mb-3 flex items-center">
                                    <Award className="w-4 h-4 mr-2" />
                                    การกระจายตามอายุงาน (ปี {currentCalcYear})
                                </h5>
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                    {Object.entries(stats.byServiceYears)
                                        .sort(([a], [b]) => parseInt(a) - parseInt(b))
                                        .map(([years, count]) => (
                                            <div key={years} className="text-center p-2 bg-green-100 rounded">
                                                <div className="text-lg font-bold text-green-900">{count}</div>
                                                <div className="text-xs text-green-700">{years} ปี</div>
                                            </div>
                                        ))}
                                </div>
                            </div>
                        )}
                        
                        <div className="bg-blue-50 p-4 rounded-lg mb-6">
                            <div className="flex items-start gap-2">
                                <Info className="w-5 h-5 text-blue-600 mt-0.5" />
                                <div className="text-sm text-blue-700">
                                    <p className="font-semibold mb-2">เกณฑ์การคำนวณและที่มาของข้อมูล:</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <ul className="space-y-1 text-xs">
                                            <li>• <strong>เกณฑ์สิทธิ์:</strong> อายุงาน 20, 25, 30, 35, หรือ 40 ปี</li>
                                            <li>• <strong>อัตราค่าใช้จ่าย:</strong> อ้างอิงจากตารางมาตรฐาน (ไม่แก้ไขได้)</li>
                                            <li>• <strong>ค่าที่พัก:</strong> ตามระดับพนักงาน × จำนวนคืน</li>
                                            <li>• <strong>ค่าเบี้ยเลี้ยง:</strong> ตามระดับพนักงาน × จำนวนวัน</li>
                                        </ul>
                                        <ul className="space-y-1 text-xs">
                                            <li>• <strong>ค่าเดินทาง:</strong> รถประจำทาง + รถรับจ้าง (ไป-กลับ)</li>
                                            <li>• <strong>จำนวนวัน/คืน:</strong> แก้ไขได้ (ใช้สำหรับทุกคน)</li>
                                            <li>• <strong>การคำนวณ:</strong> อัตโนมัติตามจำนวนที่กำหนด</li>
                                            <li>• <strong>อัปเดต:</strong> ทันทีเมื่อเปลี่ยนแปลงค่า</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h5 className="font-semibold text-yellow-800 mb-4 flex items-center">
                                <Edit3 className="w-4 h-4 mr-2" />
                                จำนวนวัน/คืน (ใช้สำหรับทุกคน - แก้ไขได้)
                            </h5>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white p-4 rounded-lg border border-yellow-300">
                                    <label className="text-sm font-medium text-yellow-700 mb-2 block">จำนวนคืนที่พัก</label>
                                    <div className="flex items-center gap-3">
                                        {renderEditableDays('hotelNights', customDays.hotelNights, 'จำนวนคืน')}
                                        <span className="text-sm text-yellow-700 font-medium">คืน</span>
                                    </div>
                                    <div className="text-xs text-orange-600 mt-2 flex items-center gap-1">
                                        <Edit3 className="w-3 h-3" />
                                        คลิกเพื่อแก้ไข
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded-lg border border-yellow-300">
                                    <label className="text-sm font-medium text-yellow-700 mb-2 block">จำนวนวันเบี้ยเลี้ยง</label>
                                    <div className="flex items-center gap-3">
                                        {renderEditableDays('perDiemDays', customDays.perDiemDays, 'จำนวนวัน')}
                                        <span className="text-sm text-yellow-700 font-medium">วัน</span>
                                    </div>
                                    <div className="text-xs text-orange-600 mt-2 flex items-center gap-1">
                                        <Edit3 className="w-3 h-3" />
                                        คลิกเพื่อแก้ไข
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 font-medium text-gray-900">รหัสพนักงาน</th>
                                    <th className="px-4 py-3 font-medium text-gray-900">ชื่อ-สกุล</th>
                                    <th className="px-4 py-3 text-center font-medium text-gray-900">
                                        <div className="flex items-center justify-center gap-1">
                                            <Award className="w-4 h-4" />
                                            อายุงาน (ปี)
                                        </div>
                                    </th>
                                    <th className="px-4 py-3 text-right font-medium text-gray-900">
                                        <div className="flex items-center justify-end gap-1">
                                            ค่าที่พัก ({customDays.hotelNights} คืน)
                                        </div>
                                    </th>
                                    <th className="px-4 py-3 text-right font-medium text-gray-900">
                                        <div className="flex items-center justify-end gap-1">
                                            ค่าเบี้ยเลี้ยง ({customDays.perDiemDays} วัน)
                                        </div>
                                    </th>
                                    <th className="px-4 py-3 text-right font-medium text-gray-900">
                                        <div className="flex items-center justify-end gap-1">
                                            ค่ารถประจำทาง (ไป-กลับ)
                                        </div>
                                    </th>
                                    <th className="px-4 py-3 text-right font-medium text-gray-900">
                                        <div className="flex items-center justify-end gap-1">
                                            ค่ารถรับจ้าง (ไป-กลับ)
                                        </div>
                                    </th>
                                    <th className="px-4 py-3 text-right font-semibold text-gray-900 bg-blue-50">
                                        <div className="flex items-center justify-end gap-1">
                                            <Calculator className="w-4 h-4" />
                                            รวม (บาท)
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {travelEmployees.length === 0 ? (
                                    <tr>
                                        <td colSpan={8} className="text-center text-gray-500 py-12">
                                            <div className="flex flex-col items-center gap-3">
                                                <AlertCircle className="w-12 h-12 text-gray-300" />
                                                <div>
                                                    <p className="font-medium">ไม่พบพนักงานที่เข้าเกณฑ์สำหรับปี พ.ศ. {currentCalcYear}</p>
                                                    <p className="text-sm mt-1">
                                                        พนักงานต้องมีอายุงาน 20, 25, 30, 35, หรือ 40 ปี ในปีที่คำนวณ
                                                    </p>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                ) : (
                                    travelEmployees.map((emp, index) => {
                                        const rates = getRatesForEmployee(emp, masterRates);
                                        const hotel = customDays.hotelNights * (rates.hotel || 0);
                                        const perDiem = customDays.perDiemDays * (rates.perDiem || 0);
                                        const travelRoundTrip = 2 * (rates.travel || 0);
                                        const localRoundTrip = 2 * (rates.local || 0);
                                        const total = hotel + perDiem + travelRoundTrip + localRoundTrip;
                                        
                                        return (
                                            <tr key={index} className="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                                                <td className="px-4 py-3">
                                                    <span className="font-mono text-gray-600 bg-gray-100 px-2 py-1 rounded text-xs">
                                                        {emp.id}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <div className="font-medium text-gray-900">{emp.name}</div>
                                                    <div className="text-xs text-gray-500">ระดับ {emp.level} • เพศ{emp.gender}</div>
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-800">
                                                        <Award className="w-4 h-4 mr-1" />
                                                        {emp.serviceYears}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3 text-right">
                                                    <div className="space-y-1">
                                                        <div className="font-medium text-blue-600">{formatCurrency(hotel)}</div>
                                                        <div className="text-xs text-gray-500">
                                                            ({formatCurrency(rates.hotel)} × {customDays.hotelNights} คืน)
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-right">
                                                    <div className="space-y-1">
                                                        <div className="font-medium text-green-600">{formatCurrency(perDiem)}</div>
                                                        <div className="text-xs text-gray-500">
                                                            ({formatCurrency(rates.perDiem)} × {customDays.perDiemDays} วัน)
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-right">
                                                    <div className="space-y-1">
                                                        <div className="font-medium text-purple-600">{formatCurrency(travelRoundTrip)}</div>
                                                        <div className="text-xs text-gray-500">
                                                            ({formatCurrency(rates.travel)} × 2 เที่ยว)
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-right">
                                                    <div className="space-y-1">
                                                        <div className="font-medium text-orange-600">{formatCurrency(localRoundTrip)}</div>
                                                        <div className="text-xs text-gray-500">
                                                            ({formatCurrency(rates.local)} × 2 เที่ยว)
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-right bg-blue-50">
                                                    <div className="font-bold text-lg text-blue-900">{formatCurrency(total)}</div>
                                                    <div className="text-xs text-blue-600">บาท</div>
                                                </td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                            {travelEmployees.length > 0 && (
                                <tfoot className="bg-gradient-to-r from-blue-50 to-blue-100 border-t-2 border-blue-200">
                                    <tr>
                                        <td colSpan={7} className="px-4 py-4 text-right font-bold text-lg text-blue-900">
                                            ยอดรวมทั้งหมด:
                                        </td>
                                        <td className="px-4 py-4 text-right">
                                            <div className="font-bold text-2xl text-blue-900">{formatCurrency(stats.totalCost)}</div>
                                            <div className="text-sm text-blue-700">บาท</div>
                                        </td>
                                    </tr>
                                </tfoot>
                            )}
                        </table>
                    </div>

                    <div className="p-6 bg-gray-50 border-t border-gray-200">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div className="flex items-center gap-6">
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">พนักงานที่มีสิทธิ์</div>
                                    <div className="text-2xl font-bold text-green-600">{stats.eligibleEmployees} คน</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">ยอดรวมทั้งหมด</div>
                                    <div className="text-2xl font-bold text-blue-600">{formatCurrency(stats.totalCost)} บาท</div>
                                </div>
                                {stats.eligibleEmployees > 0 && (
                                    <div className="text-center">
                                        <div className="text-sm text-gray-600">เฉลี่ยต่อคน</div>
                                        <div className="text-xl font-bold text-purple-600">
                                            {formatCurrency(stats.totalCost / stats.eligibleEmployees)} บาท
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-4">
                                <Button onClick={onSave} size="lg">
                                    <Save className="w-4 h-4 mr-2" />
                                    บันทึก
                                </Button>
                            </div>
                        </div>
                    </div>
                </Card>
            );
        };

        // Special Assist Calculation Table Component
        const SpecialAssistCalculationTable = ({ 
            employees, 
            masterRates, 
            selectedEmployeeIds, 
            onSave, 
            onUpdateEmployee 
        }) => {
            const [editingValues, setEditingValues] = useState({});
            const [editMode, setEditMode] = useState({});
            const [customMonths, setCustomMonths] = useState({});
            const [customLumpSum, setCustomLumpSum] = useState({});

            const eligibleEmployees = employees.filter(emp => 
                selectedEmployeeIds.includes(emp.id) &&
                emp.status === 'มีสิทธิ์'
            );
            
            const specialAssistData = calculateSpecialAssist(eligibleEmployees, masterRates);

            const getMonthsForEmployee = (empId) => {
                return customMonths[empId] || 12;
            };

            const getLumpSumForEmployee = (empId) => {
                return customLumpSum[empId] || 0;
            };

            function calculateCustomTotal() {
                return specialAssistData.reduce((sum, emp) => {
                    const rates = getRatesForEmployee(emp, masterRates);
                    const months = getMonthsForEmployee(emp.id);
                    const totalRent = rates.rent * months;
                    const totalMonthlyAssist = rates.monthlyAssist * months;
                    const lumpSum = getLumpSumForEmployee(emp.id);
                    return sum + totalRent + totalMonthlyAssist + lumpSum;
                }, 0);
            }

            const stats = {
                totalEmployees: employees.length,
                eligibleEmployees: eligibleEmployees.length,
                totalBudget: calculateCustomTotal(),
                averagePerEmployee: eligibleEmployees.length > 0 ? calculateCustomTotal() / eligibleEmployees.length : 0,
                byLevel: eligibleEmployees.reduce((acc, emp) => {
                    acc[emp.level] = (acc[emp.level] || 0) + 1;
                    return acc;
                }, {})
            };

            const handleEditStart = (empId, field, currentValue) => {
                setEditingValues(prev => ({ ...prev, [`${empId}_${field}`]: currentValue }));
                setEditMode(prev => ({ ...prev, [`${empId}_${field}`]: true }));
            };

            const handleEditSave = (empId, field) => {
                const key = `${empId}_${field}`;
                const newValue = editingValues[key];
                
                if (newValue !== undefined) {
                    if (field === 'months') {
                        setCustomMonths(prev => ({ ...prev, [empId]: parseInt(newValue) || 12 }));
                    } else if (field === 'lumpSum') {
                        setCustomLumpSum(prev => ({ ...prev, [empId]: parseFloat(newValue) || 0 }));
                    }
                }
                
                setEditMode(prev => ({ ...prev, [key]: false }));
                setEditingValues(prev => ({ ...prev, [key]: undefined }));
            };

            const handleEditCancel = (empId, field) => {
                const key = `${empId}_${field}`;
                setEditMode(prev => ({ ...prev, [key]: false }));
                setEditingValues(prev => ({ ...prev, [key]: undefined }));
            };

            const renderEditableValue = (empId, field, currentValue, label) => {
                const key = `${empId}_${field}`;
                const isEditing = editMode[key];
                
                if (isEditing) {
                    return (
                        <div className="flex items-center gap-2">
                            <input
                                type="number"
                                min={field === 'months' ? "1" : "0"}
                                max={field === 'months' ? "12" : undefined}
                                className="w-20 p-2 text-center border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                value={editingValues[key] || currentValue}
                                onChange={(e) => setEditingValues(prev => ({ ...prev, [key]: parseFloat(e.target.value) || 0 }))}
                                autoFocus
                            />
                            <Button
                                size="sm"
                                onClick={() => handleEditSave(empId, field)}
                                className="p-1 h-7 w-7"
                            >
                                <Check className="w-3 h-3" />
                            </Button>
                            <Button
                                variant="secondary"
                                size="sm"
                                onClick={() => handleEditCancel(empId, field)}
                                className="p-1 h-7 w-7"
                            >
                                <X className="w-3 h-3" />
                            </Button>
                        </div>
                    );
                }

                return (
                    <div className="flex items-center gap-2 group">
                        <span className="font-bold text-blue-600">{field === 'months' ? currentValue : formatCurrency(currentValue)}</span>
                        <Button
                            variant="secondary"
                            size="sm"
                            onClick={() => handleEditStart(empId, field, currentValue)}
                            className="p-1 h-6 w-6 opacity-0 group-hover:opacity-50 hover:opacity-100 transition-opacity"
                            title={`แก้ไข${label}`}
                        >
                            <Edit3 className="w-3 h-3" />
                        </Button>
                    </div>
                );
            };

            return (
                <Card>
                    <div className="p-6 border-b border-gray-200">
                        <h3 className="text-xl font-semibold text-gray-900 mb-6">สรุปยอดเงินช่วยเหลืออื่นๆ</h3>
                        
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg mb-6 border border-blue-200">
                            <h4 className="text-lg font-semibold text-blue-900 mb-4 flex items-center">
                                <TrendingUp className="w-5 h-5 mr-2" />
                                สรุปสำหรับผู้บริหาร
                            </h4>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-blue-900">{stats.eligibleEmployees}</div>
                                    <div className="text-sm text-blue-700">พนักงานที่มีสิทธิ์</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-green-900">{formatCurrency(stats.totalBudget)}</div>
                                    <div className="text-sm text-green-700">งบประมาณรวม</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-purple-900">{formatCurrency(stats.averagePerEmployee)}</div>
                                    <div className="text-sm text-purple-700">เฉลี่ยต่อคน</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-orange-900">{Object.keys(stats.byLevel).length}</div>
                                    <div className="text-sm text-orange-700">ระดับที่เกี่ยวข้อง</div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-yellow-50 p-4 rounded-lg mb-6 border border-yellow-200">
                            <h5 className="font-semibold text-yellow-800 mb-3 flex items-center">
                                <Info className="w-4 h-4 mr-2" />
                                วิธีการคำนวณและที่มาของข้อมูล
                            </h5>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-yellow-700">
                                <div>
                                    <p className="font-medium mb-2">🏠 ค่าเช่าบ้าน</p>
                                    <ul className="space-y-1 text-xs">
                                        <li>• อ้างอิงจากตารางอัตราค่าใช้จ่ายมาตรฐาน</li>
                                        <li>• คำนวณ: อัตราต่อเดือน × จำนวนเดือน</li>
                                        <li>• จำนวนเดือนสามารถปรับแต่งได้</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="font-medium mb-2">💰 เงินช่วยเหลือรายเดือน</p>
                                    <ul className="space-y-1 text-xs">
                                        <li>• อ้างอิงจากตารางอัตราค่าใช้จ่ายมาตรฐาน</li>
                                        <li>• คำนวณ: อัตราต่อเดือน × จำนวนเดือน</li>
                                        <li>• เชื่อมโยงกับระดับพนักงาน</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="font-medium mb-2">🛒 ค่าซื้อของเหมาจ่าย</p>
                                    <ul className="space-y-1 text-xs">
                                        <li>• ค่าใช้จ่ายเพิ่มเติมตามความจำเป็น</li>
                                        <li>• สามารถกรอกและแก้ไขได้</li>
                                        <li>• คำนวณรวมในยอดรวมอัตโนมัติ</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="font-medium mb-2">✅ เกณฑ์การมีสิทธิ์</p>
                                    <ul className="space-y-1 text-xs">
                                        <li>• สถานะพนักงาน: "มีสิทธิ์"</li>
                                        <li>• ถูกเลือกในรายการคำนวณ</li>
                                        <li>• มีข้อมูลระดับในตารางอัตรา</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        {Object.keys(stats.byLevel).length > 0 && (
                            <div className="bg-green-50 p-4 rounded-lg mb-6 border border-green-200">
                                <h5 className="font-semibold text-green-800 mb-3 flex items-center">
                                    <Users className="w-4 h-4 mr-2" />
                                    การกระจายตามระดับพนักงาน
                                </h5>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {Object.entries(stats.byLevel)
                                        .sort(([a], [b]) => parseFloat(b) - parseFloat(a))
                                        .map(([level, count]) => (
                                            <div key={level} className="text-center p-3 bg-green-100 rounded-lg">
                                                <div className="text-lg font-bold text-green-900">{count}</div>
                                                <div className="text-xs text-green-700">ระดับ {level}</div>
                                            </div>
                                        ))}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 font-medium text-gray-900 w-32">รหัสพนักงาน</th>
                                    <th className="px-4 py-3 font-medium text-gray-900 w-48">ชื่อ-สกุล</th>
                                    <th className="px-4 py-3 font-medium text-gray-900 w-24 text-center">ระดับ</th>
                                    <th className="px-4 py-3 text-right font-medium text-gray-900 w-44">
                                        <div className="flex items-center justify-end gap-1">
                                            <DollarSign className="w-4 h-4" />
                                            ค่าเช่าบ้าน
                                        </div>
                                    </th>
                                    <th className="px-4 py-3 text-right font-medium text-gray-900 w-44">
                                        <div className="flex items-center justify-end gap-1">
                                            <Heart className="w-4 h-4" />
                                            เงินช่วยเหลือรายเดือน
                                        </div>
                                    </th>
                                    <th className="px-4 py-3 text-right font-medium text-gray-900 w-40">
                                        <div className="flex items-center justify-end gap-1">
                                            <Edit3 className="w-4 h-4" />
                                            ค่าซื้อของเหมาจ่าย
                                        </div>
                                    </th>
                                    <th className="px-4 py-3 text-right font-semibold text-gray-900 bg-blue-50 w-32">
                                        <div className="flex items-center justify-end gap-1">
                                            <Calculator className="w-4 h-4" />
                                            รวม (บาท)
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {specialAssistData.length === 0 ? (
                                    <tr>
                                        <td colSpan={7} className="text-center text-gray-500 py-12">
                                            <div className="flex flex-col items-center gap-3">
                                                <AlertCircle className="w-12 h-12 text-gray-300" />
                                                <div>
                                                    <p className="font-medium">ไม่มีข้อมูลพนักงานที่เข้าเกณฑ์</p>
                                                    <p className="text-sm mt-1">พนักงานต้องมีสถานะ "มีสิทธิ์"</p>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                ) : (
                                    specialAssistData.map((emp, index) => {
                                        const rates = getRatesForEmployee(emp, masterRates);
                                        const months = getMonthsForEmployee(emp.id);
                                        const totalRent = rates.rent * months;
                                        const totalMonthlyAssist = rates.monthlyAssist * months;
                                        const lumpSum = getLumpSumForEmployee(emp.id);
                                        const total = totalRent + totalMonthlyAssist + lumpSum;
                                        
                                        return (
                                            <tr key={index} className="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                                                <td className="px-4 py-3">
                                                    <span className="font-mono text-gray-600 bg-gray-100 px-2 py-1 rounded text-xs">
                                                        {emp.id}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <div className="font-medium text-gray-900">{emp.name}</div>
                                                    <div className="text-xs text-gray-500 flex items-center gap-2">
                                                        <span>เพศ{emp.gender}</span>
                                                        <span>•</span>
                                                        <span className="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                            <CheckCircle className="w-3 h-3 mr-1" />
                                                            มีสิทธิ์
                                                        </span>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                        {emp.level}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3 text-right">
                                                    <div className="space-y-1">
                                                        <div className="font-medium text-green-600">{formatCurrency(totalRent)}</div>
                                                        <div className="text-xs text-gray-500">
                                                            {formatCurrency(rates.rent)} × {renderEditableValue(emp.id, 'months', months, 'จำนวนเดือน')} เดือน
                                                        </div>
                                                        <div className="text-xs text-blue-600">จากตารางมาตรฐาน</div>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-right">
                                                    <div className="space-y-1">
                                                        <div className="font-medium text-purple-600">{formatCurrency(totalMonthlyAssist)}</div>
                                                        <div className="text-xs text-gray-500">
                                                            {formatCurrency(rates.monthlyAssist)} × {months} เดือน
                                                        </div>
                                                        <div className="text-xs text-blue-600">จากตารางมาตรฐาน</div>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-right">
                                                    <div className="space-y-1">
                                                        {renderEditableValue(emp.id, 'lumpSum', lumpSum, 'ค่าซื้อของเหมาจ่าย')}
                                                        <div className="text-xs text-orange-600 flex items-center justify-end gap-1">
                                                            <Edit3 className="w-3 h-3" />
                                                            แก้ไขได้
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-right bg-blue-50">
                                                    <div className="font-bold text-lg text-blue-900">{formatCurrency(total)}</div>
                                                    <div className="text-xs text-blue-600">บาท</div>
                                                </td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                            {specialAssistData.length > 0 && (
                                <tfoot className="bg-gradient-to-r from-blue-50 to-blue-100 border-t-2 border-blue-200">
                                    <tr>
                                        <td colSpan={6} className="px-4 py-4 text-right font-bold text-lg text-blue-900">
                                            ยอดรวมทั้งหมด:
                                        </td>
                                        <td className="px-4 py-4 text-right">
                                            <div className="font-bold text-2xl text-blue-900">{formatCurrency(calculateCustomTotal())}</div>
                                            <div className="text-sm text-blue-700">บาท</div>
                                        </td>
                                    </tr>
                                </tfoot>
                            )}
                        </table>
                    </div>

                    <div className="p-6 bg-gray-50 border-t border-gray-200">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div className="flex items-center gap-6">
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">พนักงานที่มีสิทธิ์</div>
                                    <div className="text-2xl font-bold text-green-600">{stats.eligibleEmployees} คน</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">ยอดรวมทั้งหมด</div>
                                    <div className="text-2xl font-bold text-blue-600">{formatCurrency(calculateCustomTotal())} บาท</div>
                                </div>
                                {specialAssistData.length > 0 && (
                                    <div className="text-center">
                                        <div className="text-sm text-gray-600">เฉลี่ยต่อคน</div>
                                        <div className="text-xl font-bold text-purple-600">
                                            {formatCurrency(calculateCustomTotal() / specialAssistData.length)} บาท
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-4">
                                <Button onClick={onSave} size="lg">
                                    <Save className="w-4 h-4 mr-2" />
                                    บันทึก
                                </Button>
                            </div>
                        </div>
                    </div>
                </Card>
            );
        };

        // Family Visit Calculation Table Component
        const FamilyVisitCalculationTable = ({ 
            employees, 
            selectedEmployeeIds, 
            onSave, 
            onUpdateEmployee 
        }) => {
            const [editingValues, setEditingValues] = useState({});
            const [editMode, setEditMode] = useState({});

            const eligibleEmployees = employees.filter(emp => 
                selectedEmployeeIds.includes(emp.id) &&
                emp.level !== 'ท้องถิ่น' && 
                emp.visitProvince && 
                emp.visitProvince.trim() !== '' &&
                emp.visitProvince !== 'ขอนแก่น'
            );
            
            const familyVisitData = calculateFamilyVisit(eligibleEmployees);
            const familyVisitTotal = familyVisitData.reduce((sum, emp) => sum + emp.total, 0);

            const stats = {
                totalEmployees: employees.length,
                selectedEmployees: selectedEmployeeIds.length,
                localEmployees: employees.filter(emp => emp.level === 'ท้องถิ่น').length,
                khonKaenEmployees: employees.filter(emp => emp.visitProvince === 'ขอนแก่น').length,
                eligibleEmployees: eligibleEmployees.length,
                noProvinceEmployees: employees.filter(emp => !emp.visitProvince || emp.visitProvince.trim() === '').length
            };

            const handleEditStart = (empId, field, currentValue) => {
                setEditingValues(prev => ({ ...prev, [`${empId}_${field}`]: currentValue }));
                setEditMode(prev => ({ ...prev, [`${empId}_${field}`]: true }));
            };

            const handleEditSave = (empIndex, field, empId) => {
                const key = `${empId}_${field}`;
                const newValue = editingValues[key];
                
                if (newValue !== undefined) {
                    const employee = employees.find(emp => emp.id === empId);
                    if (employee) {
                        const globalIndex = employees.findIndex(emp => emp.id === empId);
                        if (field === 'homeVisitBusFare') {
                            onUpdateEmployee(globalIndex, { ...employee, homeVisitBusFare: parseFloat(newValue) || 0 });
                        }
                    }
                }
                
                setEditMode(prev => ({ ...prev, [key]: false }));
                setEditingValues(prev => ({ ...prev, [key]: undefined }));
            };

            const handleEditCancel = (empId, field) => {
                const key = `${empId}_${field}`;
                setEditMode(prev => ({ ...prev, [key]: false }));
                setEditingValues(prev => ({ ...prev, [key]: undefined }));
            };

            const renderEditableValue = (empId, field, currentValue, empIndex, label) => {
                const key = `${empId}_${field}`;
                const isEditing = editMode[key];
                
                if (isEditing) {
                    return (
                        <div className="flex items-center gap-2">
                            <input
                                type="number"
                                className="w-24 p-2 text-right border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                value={editingValues[key] || currentValue}
                                onChange={(e) => setEditingValues(prev => ({ ...prev, [key]: parseFloat(e.target.value) || 0 }))}
                                autoFocus
                            />
                            <Button
                                size="sm"
                                onClick={() => handleEditSave(empIndex, field, empId)}
                                className="p-1 h-7 w-7"
                            >
                                <Check className="w-3 h-3" />
                            </Button>
                            <Button
                                variant="secondary"
                                size="sm"
                                onClick={() => handleEditCancel(empId, field)}
                                className="p-1 h-7 w-7"
                            >
                                <X className="w-3 h-3" />
                            </Button>
                        </div>
                    );
                }

                return (
                    <div className="flex items-center gap-2 group">
                        <span className="font-medium">{formatCurrency(currentValue)}</span>
                        <Button
                            variant="secondary"
                            size="sm"
                            onClick={() => handleEditStart(empId, field, currentValue)}
                            className="p-1 h-6 w-6 opacity-0 group-hover:opacity-50 hover:opacity-100 transition-opacity"
                            title={`แก้ไข${label}`}
                        >
                            <Edit3 className="w-3 h-3" />
                        </Button>
                    </div>
                );
            };

            return (
                <Card>
                    <div className="p-6 border-b border-gray-200">
                        <h3 className="text-xl font-semibold text-gray-900 mb-4">สรุปค่าเดินทางเยี่ยมครอบครัว</h3>
                        
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-blue-600 text-sm font-medium">พนักงานทั้งหมด</p>
                                        <p className="text-2xl font-bold text-blue-900">{stats.totalEmployees}</p>
                                    </div>
                                    <Users className="w-8 h-8 text-blue-500" />
                                </div>
                            </div>
                            
                            <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-green-600 text-sm font-medium">มีสิทธิ์เดินทาง</p>
                                        <p className="text-2xl font-bold text-green-900">{stats.eligibleEmployees}</p>
                                    </div>
                                    <MapPin className="w-8 h-8 text-green-500" />
                                </div>
                            </div>
                            
                            <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-yellow-600 text-sm font-medium">พนักงานท้องถิ่น</p>
                                        <p className="text-2xl font-bold text-yellow-900">{stats.localEmployees}</p>
                                    </div>
                                    <AlertCircle className="w-8 h-8 text-yellow-500" />
                                </div>
                            </div>
                            
                            <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-purple-600 text-sm font-medium">อยู่ขอนแก่น</p>
                                        <p className="text-2xl font-bold text-purple-900">{stats.khonKaenEmployees}</p>
                                    </div>
                                    <MapPin className="w-8 h-8 text-purple-500" />
                                </div>
                            </div>
                        </div>
                        
                        <div className="bg-blue-50 p-4 rounded-lg mb-4">
                            <div className="flex items-start gap-2">
                                <Info className="w-5 h-5 text-blue-600 mt-0.5" />
                                <div className="text-sm text-blue-700">
                                    <p className="font-semibold mb-2">เกณฑ์การคำนวณและการกรอง:</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <ul className="space-y-1 text-xs">
                                            <li>• <strong>แสดงเฉพาะ:</strong> พนักงานที่ไม่ใช่ "ท้องถิ่น"</li>
                                            <li>• <strong>มีจังหวัดเยี่ยมบ้าน:</strong> ระบุจังหวัดแล้ว</li>
                                            <li>• <strong>ไม่ใช่ขอนแก่น:</strong> จังหวัดเยี่ยมบ้านไม่ใช่ "ขอนแก่น"</li>
                                            <li>• <strong>ถูกเลือก:</strong> อยู่ในรายการที่เลือกไว้</li>
                                        </ul>
                                        <ul className="space-y-1 text-xs">
                                            <li>• <strong>ค่ารถทัวร์:</strong> สามารถแก้ไขได้ในตาราง</li>
                                            <li>• <strong>การคำนวณ:</strong> ค่ารถ × 4 ครั้ง × 2 เที่ยว (ไป-กลับ)</li>
                                            <li>• <strong>ที่มาข้อมูล:</strong> จากตารางข้อมูลพนักงาน</li>
                                            <li>• <strong>การอัปเดต:</strong> คำนวณใหม่ทันทีเมื่อแก้ไข</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {(stats.localEmployees > 0 || stats.khonKaenEmployees > 0 || stats.noProvinceEmployees > 0) && (
                            <div className="bg-gray-50 p-4 rounded-lg mb-4">
                                <h5 className="font-semibold text-gray-800 mb-2 flex items-center">
                                    <AlertCircle className="w-4 h-4 mr-2" />
                                    พนักงานที่ไม่มีสิทธิ์เดินทางเยี่ยมครอบครัว
                                </h5>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                    {stats.localEmployees > 0 && (
                                        <div className="text-yellow-700">
                                            <strong>พนักงานท้องถิ่น:</strong> {stats.localEmployees} คน
                                            <div className="text-xs text-yellow-600">ไม่มีสิทธิ์เดินทางเยี่ยมครอบครัว</div>
                                        </div>
                                    )}
                                    {stats.khonKaenEmployees > 0 && (
                                        <div className="text-purple-700">
                                            <strong>อยู่ขอนแก่น:</strong> {stats.khonKaenEmployees} คน
                                            <div className="text-xs text-purple-600">ไม่ต้องเดินทางเยี่ยมครอบครัว</div>
                                        </div>
                                    )}
                                    {stats.noProvinceEmployees > 0 && (
                                        <div className="text-red-700">
                                            <strong>ไม่ระบุจังหวัด:</strong> {stats.noProvinceEmployees} คน
                                            <div className="text-xs text-red-600">ยังไม่ได้ระบุจังหวัดเยี่ยมบ้าน</div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 font-medium text-gray-900">รหัสพนักงาน</th>
                                    <th className="px-4 py-3 font-medium text-gray-900">ชื่อ-สกุล</th>
                                    <th className="px-4 py-3 font-medium text-gray-900">ระดับ</th>
                                    <th className="px-4 py-3 font-medium text-gray-900">จังหวัดเยี่ยมบ้าน</th>
                                    <th className="px-4 py-3 text-right font-medium text-gray-900">
                                        <div className="flex items-center justify-end gap-1">
                                            <Calculator className="w-4 h-4" />
                                            ค่ารถทัวร์ (ต่อครั้ง)
                                        </div>
                                    </th>
                                    <th className="px-4 py-3 text-right font-medium text-gray-900">
                                        <div className="flex items-center justify-end gap-1">
                                            <Calculator className="w-4 h-4" />
                                            รวม 4 ครั้ง × 2 เที่ยว
                                        </div>
                                    </th>
                                    <th className="px-4 py-3 text-right font-semibold text-gray-900 bg-blue-50">
                                        <div className="flex items-center justify-end gap-1">
                                            <Calculator className="w-4 h-4" />
                                            ยอดรวม (บาท)
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {familyVisitData.length === 0 ? (
                                    <tr>
                                        <td colSpan={7} className="text-center text-gray-500 py-12">
                                            <div className="flex flex-col items-center gap-3">
                                                <AlertCircle className="w-12 h-12 text-gray-300" />
                                                <div>
                                                    <p className="font-medium">ไม่พบพนักงานที่เข้าเกณฑ์</p>
                                                    <p className="text-sm mt-1">
                                                        พนักงานต้องไม่ใช่ "ท้องถิ่น" และมีจังหวัดเยี่ยมบ้านที่ไม่ใช่ "ขอนแก่น"
                                                    </p>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                ) : (
                                    familyVisitData.map((emp, index) => (
                                        <tr key={index} className="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                                            <td className="px-4 py-3">
                                                <span className="font-mono text-gray-600 bg-gray-100 px-2 py-1 rounded text-xs">
                                                    {emp.id}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3">
                                                <div className="font-medium text-gray-900">{emp.name}</div>
                                                <div className="text-xs text-gray-500">เพศ{emp.gender}</div>
                                            </td>
                                            <td className="px-4 py-3">
                                                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    ระดับ {emp.level}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3">
                                                <div className="flex items-center gap-2">
                                                    <MapPin className="w-4 h-4 text-green-500" />
                                                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                        {emp.visitProvince}
                                                    </span>
                                                </div>
                                            </td>
                                            <td className="px-4 py-3 text-right">
                                                <div className="space-y-1">
                                                    {renderEditableValue(emp.id, 'homeVisitBusFare', emp.homeVisitBusFare, index, 'ค่ารถทัวร์')}
                                                    <div className="text-xs text-orange-600 flex items-center justify-end gap-1">
                                                        <Edit3 className="w-3 h-3" />
                                                        แก้ไขได้
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="px-4 py-3 text-right">
                                                <div className="space-y-1">
                                                    <div className="font-medium text-blue-600">{formatCurrency(emp.busFareTotal)}</div>
                                                    <div className="text-xs text-gray-500">
                                                        ({formatCurrency(emp.homeVisitBusFare)} × 4 × 2)
                                                    </div>
                                                    <div className="text-xs text-blue-600 flex items-center justify-end gap-1">
                                                        <Calculator className="w-3 h-3" />
                                                        คำนวณอัตโนมัติ
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="px-4 py-3 text-right bg-blue-50">
                                                <div className="font-bold text-lg text-blue-900">{formatCurrency(emp.total)}</div>
                                                <div className="text-xs text-blue-600">บาท</div>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                            {familyVisitData.length > 0 && (
                                <tfoot className="bg-gradient-to-r from-blue-50 to-blue-100 border-t-2 border-blue-200">
                                    <tr>
                                        <td colSpan={6} className="px-4 py-4 text-right font-bold text-lg text-blue-900">
                                            ยอดรวมทั้งหมด:
                                        </td>
                                        <td className="px-4 py-4 text-right">
                                            <div className="font-bold text-2xl text-blue-900">{formatCurrency(familyVisitTotal)}</div>
                                            <div className="text-sm text-blue-700">บาท</div>
                                        </td>
                                    </tr>
                                </tfoot>
                            )}
                        </table>
                    </div>

                    <div className="p-6 bg-gray-50 border-t border-gray-200">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div className="flex items-center gap-6">
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">พนักงานที่มีสิทธิ์</div>
                                    <div className="text-2xl font-bold text-green-600">{stats.eligibleEmployees} คน</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">ยอดรวมทั้งหมด</div>
                                    <div className="text-2xl font-bold text-blue-600">{formatCurrency(familyVisitTotal)} บาท</div>
                                </div>
                                {familyVisitData.length > 0 && (
                                    <div className="text-center">
                                        <div className="text-sm text-gray-600">เฉลี่ยต่อคน</div>
                                        <div className="text-xl font-bold text-purple-600">
                                            {formatCurrency(familyVisitTotal / familyVisitData.length)} บาท
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-4">
                                <Button onClick={onSave} size="lg">
                                    <Save className="w-4 h-4 mr-2" />
                                    บันทึก
                                </Button>
                            </div>
                        </div>
                    </div>
                </Card>
            );
        };

        // Work Day Calculator Component
        const WorkDayCalculator = ({ 
            calcYear, 
            holidaysData, 
            onYearChange, 
            onAddHoliday, 
            onDeleteHoliday, 
            onSave 
        }) => {
            const yearCE = calcYear - 543;
            const holidays = holidaysData[yearCE] || [];
            const workDayCalc = calculateWorkDays(calcYear, holidays);

            const handleAddHoliday = () => {
                const dateInput = document.getElementById('new-holiday-date');
                const nameInput = document.getElementById('new-holiday-name');
                
                if (!dateInput.value || !nameInput.value) {
                    alert('กรุณาระบุวันที่และชื่อวันหยุด');
                    return;
                }

                onAddHoliday(yearCE, {
                    date: dateInput.value,
                    name: nameInput.value
                });

                dateInput.value = '';
                nameInput.value = '';
            };

            const formatThaiDate = (dateStr) => {
                const [year, month, day] = dateStr.split('-');
                return `${day}/${month}/${parseInt(year) + 543}`;
            };

            const getHolidayStats = () => {
                const recentYears = Object.keys(holidaysData)
                    .map(Number)
                    .filter(year => year >= yearCE - 5 && year < yearCE)
                    .sort((a, b) => b - a);
                
                if (recentYears.length === 0) return null;
                
                const yearlyData = recentYears.map(year => ({
                    year: year + 543,
                    holidays: holidaysData[year] || [],
                    count: holidaysData[year]?.length || 0
                }));
                
                const holidayCounts = yearlyData.map(data => data.count);
                const averageHolidays = Math.round(holidayCounts.reduce((s, c) => s + c, 0) / recentYears.length);
                
                const holidayFrequency = {};
                
                yearlyData.forEach(({ holidays }) => {
                    holidays.forEach(holiday => {
                        const month = holiday.date.split('-')[1];
                        const key = holiday.name.replace(/ชดเชย|วันหยุดพิเศษ/g, '').trim();
                        
                        if (!holidayFrequency[key]) {
                            holidayFrequency[key] = { name: holiday.name, count: 0, months: new Set() };
                        }
                        holidayFrequency[key].count++;
                        holidayFrequency[key].months.add(month);
                    });
                });
                
                const commonHolidays = Object.entries(holidayFrequency)
                    .filter(([_, data]) => data.count >= Math.ceil(recentYears.length * 0.6))
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, averageHolidays)
                    .map(([key, data]) => ({
                        name: data.name,
                        frequency: `${data.count}/${recentYears.length} ปี`,
                        months: Array.from(data.months).sort()
                    }));
                
                return {
                    recentYears: recentYears.map(y => y + 543),
                    yearlyData,
                    averageHolidays,
                    estimatedWorkDays: workDayCalc.weekdays - averageHolidays,
                    commonHolidays
                };
            };

            const stats = getHolidayStats();

            return (
                <Card>
                    <div className="p-6 border-b border-gray-200">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-semibold text-gray-900">
                                คำนวณและจัดการวันทำงานประจำปี
                            </h3>
                            <div className="flex items-center gap-4">
                                <Button
                                    variant="secondary"
                                    size="sm"
                                    onClick={() => onYearChange(calcYear - 1)}
                                >
                                    <ChevronLeft className="w-4 h-4 mr-1" />
                                    ปีก่อนหน้า
                                </Button>
                                <div className="text-center">
                                    <div className="text-sm text-gray-600">คำนวณสำหรับปี พ.ศ.</div>
                                    <div className="text-xl font-bold text-blue-600">{calcYear}</div>
                                </div>
                                <Button
                                    variant="secondary"
                                    size="sm"
                                    onClick={() => onYearChange(calcYear + 1)}
                                >
                                    ปีถัดไป
                                    <ChevronRight className="w-4 h-4 ml-1" />
                                </Button>
                            </div>
                        </div>
                    </div>

                    <div className="p-6">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                {holidays.length > 0 ? (
                                    <motion.div
                                        initial={{ opacity: 0, y: 20 }}
                                        animate={{ opacity: 1, y: 0 }}
                                        className="bg-blue-50 p-6 rounded-lg space-y-4"
                                    >
                                        <div className="flex items-center gap-2 mb-4">
                                            <Calendar className="w-5 h-5 text-blue-600" />
                                            <h4 className="text-xl font-bold text-blue-800">
                                                สรุปวันทำงานปี พ.ศ. {calcYear}
                                            </h4>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-4 text-base">
                                            <span className="font-semibold">วันทำงาน (จันทร์-ศุกร์):</span>
                                            <span className="text-right">{workDayCalc.weekdays} วัน</span>
                                            
                                            <span className="font-semibold">วันหยุดที่ตกในวันทำงาน:</span>
                                            <span className="text-right text-red-600">-{workDayCalc.holidaysOnWeekdays} วัน</span>
                                        </div>
                                        
                                        <div className="border-t border-blue-200 pt-4 mt-4 flex justify-between items-center text-xl font-bold">
                                            <span>สรุปวันทำงานจริง:</span>
                                            <span className="text-blue-700">{workDayCalc.totalWorkDays} วัน</span>
                                        </div>

                                        <div className="mt-4 p-4 bg-blue-100 rounded-lg">
                                            <div className="text-sm text-blue-700">
                                                <strong>รายละเอียด:</strong> จากวันทำงานทั้งหมด {workDayCalc.weekdays} วัน 
                                                หักวันหยุดสถาบันการเงิน {workDayCalc.holidaysOnWeekdays} วัน 
                                                คงเหลือวันทำงานจริง {workDayCalc.totalWorkDays} วัน
                                            </div>
                                        </div>
                                    </motion.div>
                                ) : stats ? (
                                    <motion.div
                                        initial={{ opacity: 0, y: 20 }}
                                        animate={{ opacity: 1, y: 0 }}
                                        className="bg-yellow-50 p-6 rounded-lg space-y-4"
                                    >
                                        <div className="flex items-center gap-2 mb-4">
                                            <TrendingUp className="w-5 h-5 text-yellow-600" />
                                            <h4 className="text-xl font-bold text-yellow-800">
                                                ประมาณการวันทำงานปี พ.ศ. {calcYear}
                                            </h4>
                                        </div>
                                        
                                        <div className="bg-yellow-100 p-4 rounded-lg mb-4">
                                            <p className="text-sm text-yellow-700 mb-3">
                                                <strong>หมายเหตุ:</strong> เนื่องจากไม่มีข้อมูลประกาศของปีที่เลือก ระบบจึงคำนวณจากค่าเฉลี่ย 5 ปีย้อนหลัง
                                            </p>
                                            
                                            <div className="text-xs text-yellow-600">
                                                <strong>ข้อมูลอ้างอิง:</strong>
                                                <div className="grid grid-cols-2 gap-2 mt-2">
                                                    {stats.yearlyData.map(({ year, count }) => (
                                                        <div key={year} className="flex justify-between">
                                                            <span>ปี {year}:</span>
                                                            <span>{count} วัน</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-4 text-base">
                                            <span className="font-semibold">วันทำงาน (จันทร์-ศุกร์):</span>
                                            <span className="text-right">{workDayCalc.weekdays} วัน</span>
                                            
                                            <span className="font-semibold">ประมาณการวันหยุด:</span>
                                            <span className="text-right text-red-600">-{stats.averageHolidays} วัน</span>
                                        </div>
                                        
                                        <div className="border-t border-yellow-300 pt-4 mt-4 flex justify-between items-center text-xl font-bold">
                                            <span>ประมาณการวันทำงานจริง:</span>
                                            <span className="text-yellow-700">{stats.estimatedWorkDays} วัน</span>
                                        </div>

                                        {stats.commonHolidays.length > 0 && (
                                            <div className="mt-4 p-4 bg-yellow-100 rounded-lg">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <Clock className="w-4 h-4 text-yellow-600" />
                                                    <h5 className="font-semibold text-yellow-800">
                                                        วันหยุดที่คาดว่าจะมี (ประมาณการ {stats.averageHolidays} วัน)
                                                    </h5>
                                                </div>
                                                <div className="space-y-2 text-sm text-yellow-700">
                                                    {stats.commonHolidays.map((holiday, index) => (
                                                        <div key={index} className="flex justify-between items-center">
                                                            <span className="flex-1">{holiday.name}</span>
                                                            <span className="text-xs bg-yellow-200 px-2 py-1 rounded">
                                                                {holiday.frequency}
                                                            </span>
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="mt-3 pt-3 border-t border-yellow-200 text-xs text-yellow-600">
                                                    * ประมาณการจากความถี่ของวันหยุดในช่วง 5 ปีที่ผ่านมา
                                                </div>
                                            </div>
                                        )}
                                    </motion.div>
                                ) : (
                                    <div className="bg-red-50 p-6 rounded-lg">
                                        <div className="flex items-center gap-2 mb-2">
                                            <Info className="w-5 h-5 text-red-600" />
                                            <h4 className="font-bold text-red-800">ไม่สามารถคำนวณได้</h4>
                                        </div>
                                        <p className="text-red-700">
                                            ไม่มีข้อมูลวันหยุดย้อนหลังเพื่อใช้ในการคำนวณประมาณการ
                                        </p>
                                    </div>
                                )}
                            </div>

                            <div>
                                <h4 className="text-xl font-bold text-gray-800 mb-4">
                                    จัดการวันหยุดสถาบันการเงิน
                                </h4>
                                
                                <div className="bg-gray-50 p-4 rounded-lg mb-6">
                                    <h5 className="font-semibold mb-3">เพิ่มวันหยุดใหม่</h5>
                                    <div className="flex gap-2">
                                        <input
                                            type="date"
                                            id="new-holiday-date"
                                            className="flex-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                        <input
                                            type="text"
                                            id="new-holiday-name"
                                            placeholder="ชื่อวันหยุด"
                                            className="flex-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                        <Button onClick={handleAddHoliday} size="sm">
                                            <Plus className="w-4 h-4 mr-1" />
                                            เพิ่ม
                                        </Button>
                                    </div>
                                </div>

                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {holidays.length === 0 ? (
                                        <div className="text-center text-gray-500 py-8">
                                            <Calendar className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                                            <p>ไม่มีข้อมูลวันหยุดสำหรับปีนี้</p>
                                            <p className="text-sm mt-1">เพิ่มวันหยุดใหม่เพื่อเริ่มต้นการคำนวณ</p>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="mb-3 p-3 bg-blue-50 rounded-lg">
                                                <div className="text-sm text-blue-700">
                                                    <strong>สถิติปี {calcYear}:</strong> มีวันหยุดทั้งหมด {holidays.length} วัน 
                                                    ตกในวันทำงาน {workDayCalc.holidaysOnWeekdays} วัน
                                                </div>
                                            </div>
                                            
                                            {holidays.map((holiday, index) => (
                                                <motion.div
                                                    key={index}
                                                    initial={{ opacity: 0, x: -20 }}
                                                    animate={{ opacity: 1, x: 0 }}
                                                    transition={{ delay: index * 0.05 }}
                                                    className="flex items-center justify-between bg-white p-3 rounded-md shadow-sm border border-gray-200 hover:bg-gray-50"
                                                >
                                                    <div className="flex-grow">
                                                        <span className="font-semibold text-blue-600">
                                                            {formatThaiDate(holiday.date)}
                                                        </span>
                                                        <span className="text-gray-700 ml-3">{holiday.name}</span>
                                                    </div>
                                                    <Button
                                                        variant="danger"
                                                        size="sm"
                                                        onClick={() => onDeleteHoliday(yearCE, index)}
                                                    >
                                                        <Trash2 className="w-4 h-4" />
                                                    </Button>
                                                </motion.div>
                                            ))}
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="mt-8 pt-6 border-t border-gray-200 flex justify-end">
                            <Button onClick={onSave} size="lg">
                                บันทึกข้อมูลวันหยุด
                            </Button>
                        </div>
                    </div>
                </Card>
            );
        };

        // Main Budget Data Hook
        const useBudgetData = () => {
            const [budgetData, setBudgetData] = useState([]);
            const [employees, setEmployees] = useState([]);
            const [masterRates, setMasterRates] = useState({});
            const [specialAssist1DataByYear, setSpecialAssist1DataByYear] = useState({});
            const [overtimeDataByYear, setOvertimeDataByYear] = useState({});
            const [holidaysData, setHolidaysData] = useState(holidaysByYear);
            
            const [selectedTravelEmployees, setSelectedTravelEmployees] = useState([]);
            const [selectedSpecialAssistEmployees, setSelectedSpecialAssistEmployees] = useState([]);
            const [selectedFamilyVisitEmployees, setSelectedFamilyVisitEmployees] = useState([]);
            const [selectedCompanyTripEmployees, setSelectedCompanyTripEmployees] = useState([]);
            const [selectedManagerRotationEmployees, setSelectedManagerRotationEmployees] = useState([]);
            
            const [isLoading, setIsLoading] = useState(true);

            const initializeBudgetData = (items) => {
                return items.map(item => {
                    if (item.type) return item;
                    const newItem = { ...item, values: {} };
                    for (let year = 2568; year <= 2580; year++) {
                        newItem.values[year] = 0;
                    }
                    return newItem;
                });
            };

            const getSpecialAssist1DataForYear = (year) => {
                if (!specialAssist1DataByYear[year]) {
                    const newData = {
                        items: JSON.parse(JSON.stringify(defaultSpecialAssist1Data)),
                        notes: ''
                    };
                    setSpecialAssist1DataByYear(prev => ({ ...prev, [year]: newData }));
                    return newData;
                }
                return specialAssist1DataByYear[year];
            };

            const getOvertimeDataForYear = (year) => {
                if (!overtimeDataByYear[year]) {
                    const refYear = year - 1;
                    const refYearCE = refYear - 543;
                    const refHolidays = holidaysData[refYearCE] || [];
                    
                    let consecutiveCounts = { 3: 0, 4: 0, 5: 0 };
                    if (refHolidays.length > 0) {
                        let consecutive = 0;
                        for (let i = 0; i < refHolidays.length; i++) {
                            const currentDay = new Date(refHolidays[i].date).getTime();
                            const prevDay = i > 0 ? new Date(refHolidays[i-1].date).getTime() : 0;
                            
                            if (i > 0 && (currentDay - prevDay) / (1000 * 3600 * 24) === 1) {
                                consecutive++;
                            } else {
                                if (consecutive >= 3 && consecutive <= 5) {
                                    consecutiveCounts[consecutive]++;
                                }
                                consecutive = 1;
                            }
                        }
                        if (consecutive >= 3 && consecutive <= 5) {
                            consecutiveCounts[consecutive]++;
                        }
                    }

                    const newData = {
                        salary: 15000,
                        items: [
                            { item: 'วันหยุดยาว 3 วัน', days: 3, instances: consecutiveCounts[3], hours: 8, people: 1 },
                            { item: 'วันหยุดยาว 4 วัน', days: 4, instances: consecutiveCounts[4], hours: 8, people: 1 },
                            { item: 'วันหยุดยาว 5 วัน', days: 5, instances: consecutiveCounts[5], hours: 8, people: 1 },
                        ]
                    };
                    setOvertimeDataByYear(prev => ({ ...prev, [year]: newData }));
                    return newData;
                }
                return overtimeDataByYear[year];
            };

            useEffect(() => {
                const loadData = () => {
                    try {
                        const savedBudget = StorageManager.load('BUDGET', []);
                        const defaultData = initializeBudgetData(defaultBudgetItems);
                        
                        if (savedBudget.length > 0) {
                            const mergedBudget = defaultData.map(defaultItem => {
                                if (defaultItem.type) return defaultItem;
                                const savedItem = savedBudget.find(s => s.code === defaultItem.code);
                                if (savedItem) {
                                    const mergedValues = { ...defaultItem.values, ...savedItem.values };
                                    return { ...defaultItem, ...savedItem, values: mergedValues };
                                }
                                return defaultItem;
                            });
                            setBudgetData(mergedBudget);
                        } else {
                            setBudgetData(defaultData);
                        }

                        const loadedEmployees = StorageManager.load('EMPLOYEES', defaultEmployees);
                        setEmployees(loadedEmployees);
                        setMasterRates(StorageManager.load('MASTER_RATES', defaultMasterRates));
                        setSpecialAssist1DataByYear(StorageManager.load('ASSIST1', {}));
                        setOvertimeDataByYear(StorageManager.load('OVERTIME', {}));
                        
                        const savedHolidays = StorageManager.load('HOLIDAYS', holidaysByYear);
                        setHolidaysData(savedHolidays);

                        const allEmployeeIds = loadedEmployees.map(emp => emp.id);
                        setSelectedTravelEmployees(allEmployeeIds);
                        setSelectedSpecialAssistEmployees(allEmployeeIds);
                        setSelectedFamilyVisitEmployees(allEmployeeIds);
                        setSelectedCompanyTripEmployees(allEmployeeIds);
                        setSelectedManagerRotationEmployees(allEmployeeIds);
                    } catch (error) {
                        console.error('Error loading data:', error);
                        setBudgetData(initializeBudgetData(defaultBudgetItems));
                        setEmployees(defaultEmployees);
                        setMasterRates(defaultMasterRates);
                        setHolidaysData(holidaysByYear);
                        
                        const allEmployeeIds = defaultEmployees.map(emp => emp.id);
                        setSelectedTravelEmployees(allEmployeeIds);
                        setSelectedSpecialAssistEmployees(allEmployeeIds);
                        setSelectedFamilyVisitEmployees(allEmployeeIds);
                        setSelectedCompanyTripEmployees(allEmployeeIds);
                        setSelectedManagerRotationEmployees(allEmployeeIds);
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadData();
            }, []);

            useEffect(() => {
                const allEmployeeIds = employees.map(emp => emp.id);
                
                setSelectedTravelEmployees(prev => {
                    const validIds = prev.filter(id => allEmployeeIds.includes(id));
                    const newIds = allEmployeeIds.filter(id => !prev.includes(id));
                    return [...validIds, ...newIds];
                });
                
                setSelectedSpecialAssistEmployees(prev => {
                    const validIds = prev.filter(id => allEmployeeIds.includes(id));
                    const newIds = allEmployeeIds.filter(id => !prev.includes(id));
                    return [...validIds, ...newIds];
                });
                
                setSelectedFamilyVisitEmployees(prev => {
                    const validIds = prev.filter(id => allEmployeeIds.includes(id));
                    const newIds = allEmployeeIds.filter(id => !prev.includes(id));
                    return [...validIds, ...newIds];
                });
                
                setSelectedCompanyTripEmployees(prev => {
                    const validIds = prev.filter(id => allEmployeeIds.includes(id));
                    const newIds = allEmployeeIds.filter(id => !prev.includes(id));
                    return [...validIds, ...newIds];
                });
                
                setSelectedManagerRotationEmployees(prev => {
                    const validIds = prev.filter(id => allEmployeeIds.includes(id));
                    const newIds = allEmployeeIds.filter(id => !prev.includes(id));
                    return [...validIds, ...newIds];
                });
            }, [employees]);

            const saveAllData = () => {
                StorageManager.save('BUDGET', budgetData);
                StorageManager.save('EMPLOYEES', employees);
                StorageManager.save('MASTER_RATES', masterRates);
                StorageManager.save('ASSIST1', specialAssist1DataByYear);
                StorageManager.save('OVERTIME', overtimeDataByYear);
                StorageManager.save('HOLIDAYS', holidaysData);
            };

            const updateBudgetItem = (index, year, value) => {
                setBudgetData(prev => {
                    const updated = [...prev];
                    if (updated[index].values) {
                        updated[index].values[year] = value;
                    }
                    return updated;
                });
            };

            const updateBudgetNotes = (index, notes) => {
                setBudgetData(prev => {
                    const updated = [...prev];
                    updated[index].notes = notes;
                    return updated;
                });
            };

            const updateEmployee = (index, employee) => {
                setEmployees(prev => {
                    const updated = [...prev];
                    updated[index] = employee;
                    return updated;
                });
            };

            const addEmployee = () => {
                const newEmployee = {
                    id: '',
                    name: '',
                    gender: 'ชาย',
                    startYear: new Date().getFullYear() + 543,
                    level: '3',
                    status: 'มีสิทธิ์',
                    visitProvince: '',
                    homeVisitBusFare: 0
                };
                setEmployees(prev => [newEmployee, ...prev]);
            };

            const deleteEmployee = (index) => {
                setEmployees(prev => prev.filter((_, i) => i !== index));
            };

            const updateMasterRate = (level, key, value) => {
                setMasterRates(prev => ({
                    ...prev,
                    [level]: {
                        ...prev[level],
                        [key]: key === 'position' ? value : (parseFloat(value) || 0)
                    }
                }));
            };

            const updateSpecialAssist1Item = (year, index, key, value) => {
                setSpecialAssist1DataByYear(prev => {
                    const yearData = prev[year] || { items: [], notes: '' };
                    const updatedItems = [...yearData.items];
                    const isNumeric = key !== 'item';
                    updatedItems[index] = {
                        ...updatedItems[index],
                        [key]: isNumeric ? (parseFloat(value) || 0) : value
                    };
                    return {
                        ...prev,
                        [year]: { ...yearData, items: updatedItems }
                    };
                });
            };

            const updateSpecialAssist1Notes = (year, notes) => {
                setSpecialAssist1DataByYear(prev => ({
                    ...prev,
                    [year]: { ...prev[year], notes }
                }));
            };

            const updateOvertimeData = (year, field, indexOrValue, key, value) => {
                setOvertimeDataByYear(prev => {
                    const yearData = prev[year] || { salary: 15000, items: [] };
                    if (field === 'salary') {
                        return {
                            ...prev,
                            [year]: { ...yearData, salary: parseFloat(indexOrValue) || 0 }
                        };
                    } else if (field === 'items' && key) {
                        const updatedItems = [...yearData.items];
                        const isNumeric = key !== 'item';
                        updatedItems[indexOrValue] = {
                            ...updatedItems[indexOrValue],
                            [key]: isNumeric ? (parseFloat(value) || 0) : value
                        };
                        return {
                            ...prev,
                            [year]: { ...yearData, items: updatedItems }
                        };
                    }
                    return prev;
                });
            };

            const addHoliday = (yearCE, holiday) => {
                setHolidaysData(prev => {
                    const yearHolidays = [...(prev[yearCE] || []), holiday];
                    yearHolidays.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
                    return { ...prev, [yearCE]: yearHolidays };
                });
            };

            const deleteHoliday = (yearCE, index) => {
                setHolidaysData(prev => ({
                    ...prev,
                    [yearCE]: prev[yearCE]?.filter((_, i) => i !== index) || []
                }));
            };

            const resetAllData = () => {
                StorageManager.clear();
                setBudgetData(initializeBudgetData(defaultBudgetItems));
                setEmployees([...defaultEmployees]);
                setMasterRates({ ...defaultMasterRates });
                setSpecialAssist1DataByYear({});
                setOvertimeDataByYear({});
                setHolidaysData(holidaysByYear);
                
                const allEmployeeIds = defaultEmployees.map(emp => emp.id);
                setSelectedTravelEmployees(allEmployeeIds);
                setSelectedSpecialAssistEmployees(allEmployeeIds);
                setSelectedFamilyVisitEmployees(allEmployeeIds);
                setSelectedCompanyTripEmployees(allEmployeeIds);
                setSelectedManagerRotationEmployees(allEmployeeIds);
            };

            return {
                budgetData,
                employees,
                masterRates,
                specialAssist1DataByYear,
                overtimeDataByYear,
                holidaysData,
                selectedTravelEmployees,
                selectedSpecialAssistEmployees,
                selectedFamilyVisitEmployees,
                selectedCompanyTripEmployees,
                selectedManagerRotationEmployees,
                isLoading,
                updateBudgetItem,
                updateBudgetNotes,
                updateEmployee,
                addEmployee,
                deleteEmployee,
                updateMasterRate,
                setEmployees,
                getSpecialAssist1DataForYear,
                getOvertimeDataForYear,
                updateSpecialAssist1Item,
                updateSpecialAssist1Notes,
                updateOvertimeData,
                addHoliday,
                deleteHoliday,
                setSelectedTravelEmployees,
                setSelectedSpecialAssistEmployees,
                setSelectedFamilyVisitEmployees,
                setSelectedCompanyTripEmployees,
                setSelectedManagerRotationEmployees,
                saveAllData,
                resetAllData
            };
        };

        // Main App Component
        const App = () => {
            const {
                budgetData,
                employees,
                masterRates,
                specialAssist1DataByYear,
                overtimeDataByYear,
                holidaysData,
                selectedTravelEmployees,
                selectedSpecialAssistEmployees,
                selectedFamilyVisitEmployees,
                selectedCompanyTripEmployees,
                selectedManagerRotationEmployees,
                isLoading,
                updateBudgetItem,
                updateBudgetNotes,
                updateEmployee,
                addEmployee,
                deleteEmployee,
                updateMasterRate,
                setEmployees,
                getSpecialAssist1DataForYear,
                getOvertimeDataForYear,
                updateSpecialAssist1Item,
                updateSpecialAssist1Notes,
                updateOvertimeData,
                addHoliday,
                deleteHoliday,
                setSelectedTravelEmployees,
                setSelectedSpecialAssistEmployees,
                setSelectedFamilyVisitEmployees,
                setSelectedCompanyTripEmployees,
                setSelectedManagerRotationEmployees,
                saveAllData,
                resetAllData
            } = useBudgetData();

            const [activeTab, setActiveTab] = useState('dashboard');
            const [currentYear, setCurrentYear] = useState(2568);
            const [nextYear, setNextYear] = useState(2569);
            const [calcYear, setCalcYear] = useState(2569);
            const [toast, setToast] = useState({
                isVisible: false,
                message: '',
                type: 'success'
            });

            const showToast = useCallback((message, type = 'success') => {
                setToast({ isVisible: true, message, type });
            }, []);

            const hideToast = useCallback(() => {
                setToast(prev => ({ ...prev, isVisible: false }));
            }, []);

            const handleSave = useCallback(() => {
                try {
                    saveAllData();
                    showToast('บันทึกข้อมูลเรียบร้อยแล้ว');
                } catch (error) {
                    showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
                }
            }, [saveAllData, showToast]);

            const handleReset = useCallback(() => {
                if (window.confirm('คุณต้องการลบข้อมูลที่บันทึกไว้ทั้งหมดและกลับไปใช้ค่าเริ่มต้นใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                    resetAllData();
                    showToast('ล้างข้อมูลเรียบร้อยแล้ว');
                }
            }, [resetAllData, showToast]);

            const handleUpdateSelection = useCallback((type, employeeIds) => {
                switch (type) {
                    case 'travel':
                        setSelectedTravelEmployees(employeeIds);
                        break;
                    case 'special-assist':
                        setSelectedSpecialAssistEmployees(employeeIds);
                        break;
                    case 'family-visit':
                        setSelectedFamilyVisitEmployees(employeeIds);
                        break;
                    case 'company-trip':
                        setSelectedCompanyTripEmployees(employeeIds);
                        break;
                    case 'manager-rotation':
                        setSelectedManagerRotationEmployees(employeeIds);
                        break;
                }
            }, [
                setSelectedTravelEmployees,
                setSelectedSpecialAssistEmployees,
                setSelectedFamilyVisitEmployees,
                setSelectedCompanyTripEmployees,
                setSelectedManagerRotationEmployees
            ]);

            const yearOptions = Array.from({ length: 13 }, (_, i) => 2568 + i);

            const renderTabContent = () => {
                const contentVariants = {
                    initial: { opacity: 0, y: 20 },
                    animate: { opacity: 1, y: 0 },
                    exit: { opacity: 0, y: -20 }
                };

                switch (activeTab) {
                    case 'dashboard':
                        return (
                            <motion.div
                                key="dashboard"
                                variants={contentVariants}
                                initial="initial"
                                animate="animate"
                                exit="exit"
                                transition={{ duration: 0.3 }}
                            >
                                <Dashboard
                                    budgetData={budgetData}
                                    employees={employees}
                                    currentYear={currentYear}
                                    nextYear={nextYear}
                                    onNavigate={setActiveTab}
                                />
                            </motion.div>
                        );

                    case 'budget':
                        return (
                            <motion.div
                                key="budget"
                                variants={contentVariants}
                                initial="initial"
                                animate="animate"
                                exit="exit"
                                transition={{ duration: 0.3 }}
                            >
                                <Card>
                                    <div className="p-6 bg-gray-50 border-b border-gray-200">
                                        <div className="flex flex-wrap items-center justify-center gap-6">
                                            <div className="flex items-center gap-3">
                                                <label className="font-semibold text-gray-700">เปรียบเทียบปี:</label>
                                                <select
                                                    value={currentYear}
                                                    onChange={(e) => setCurrentYear(Number(e.target.value))}
                                                    className="px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                >
                                                    {yearOptions.map(year => (
                                                        <option key={year} value={year}>{year}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <label className="font-semibold text-gray-700">กับปี:</label>
                                                <select
                                                    value={nextYear}
                                                    onChange={(e) => {
                                                        const year = Number(e.target.value);
                                                        setNextYear(year);
                                                        setCalcYear(year);
                                                    }}
                                                    className="px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                >
                                                    {yearOptions.map(year => (
                                                        <option key={year} value={year}>{year}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <BudgetTable
                                        budgetData={budgetData}
                                        currentYear={currentYear}
                                        nextYear={nextYear}
                                        onUpdateBudget={updateBudgetItem}
                                        onUpdateNotes={updateBudgetNotes}
                                    />
                                    <div className="p-6 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                                        <div className="flex gap-4">
                                            <Button onClick={handleSave}>
                                                <Save className="w-4 h-4 mr-2" />
                                                บันทึก
                                            </Button>
                                        </div>
                                    </div>
                                </Card>
                            </motion.div>
                        );

                    case 'config':
                        return (
                            <motion.div
                                key="config"
                                variants={contentVariants}
                                initial="initial"
                                animate="animate"
                                exit="exit"
                                transition={{ duration: 0.3 }}
                                className="space-y-8"
                            >
                                <Card>
                                    <div className="p-6 border-b border-gray-200">
                                        <h3 className="text-xl font-semibold text-gray-900">ตารางอัตราค่าใช้จ่ายมาตรฐาน</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-4 py-3">ตำแหน่ง</th>
                                                    <th className="px-4 py-3">ระดับ</th>
                                                    <th className="px-4 py-3 text-right">ค่าเช่าบ้าน</th>
                                                    <th className="px-4 py-3 text-right">เงินช่วยเหลือรายเดือน</th>
                                                    <th className="px-4 py-3 text-right">ค่าซื้อของเหมาจ่าย</th>
                                                    <th className="px-4 py-3 text-right">ค่ารถประจำทาง โคราช - กทม</th>
                                                    <th className="px-4 py-3 text-right">ค่ารถรับจ้าง ขนส่ง-ที่พัก</th>
                                                    <th className="px-4 py-3 text-right">ค่าเบี้ยเลี้ยง</th>
                                                    <th className="px-4 py-3 text-right">ค่าที่พัก</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {Object.keys(masterRates)
                                                    .sort((a, b) => parseFloat(b) - parseFloat(a))
                                                    .map(level => {
                                                        const data = masterRates[level];
                                                        return (
                                                            <tr key={level} className="border-b border-gray-200 hover:bg-gray-50">
                                                                <td className="p-3">
                                                                    <input
                                                                        type="text"
                                                                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                                                        value={data.position}
                                                                        onChange={(e) => updateMasterRate(level, 'position', e.target.value)}
                                                                    />
                                                                </td>
                                                                <td className="px-4 py-3 text-center font-medium">{level}</td>
                                                                {['rent', 'monthlyAssist', 'lumpSum', 'travel', 'local', 'perDiem', 'hotel'].map(key => (
                                                                    <td key={key} className="p-3">
                                                                        <input
                                                                            type="number"
                                                                            className="w-full p-2 border border-gray-300 rounded-md text-right focus:ring-2 focus:ring-blue-500"
                                                                            value={data[key]}
                                                                            onChange={(e) => updateMasterRate(level, key, e.target.value)}
                                                                        />
                                                                    </td>
                                                                ))}
                                                            </tr>
                                                        );
                                                    })}
                                            </tbody>
                                        </table>
                                    </div>
                                </Card>

                                <div className="space-y-6">
                                    <div className="flex flex-wrap justify-between items-center gap-4">
                                        <h3 className="text-xl font-semibold text-gray-900">รายชื่อพนักงาน</h3>
                                        <div className="flex gap-3">
                                            <Button onClick={handleReset} variant="danger" size="sm">
                                                <RotateCcw className="w-4 h-4 mr-2" />
                                                ล้างข้อมูลทั้งหมด
                                            </Button>
                                        </div>
                                    </div>
                                    
                                    <EmployeeTable
                                        employees={employees}
                                        masterRates={masterRates}
                                        selectedTravelEmployees={selectedTravelEmployees}
                                        selectedSpecialAssistEmployees={selectedSpecialAssistEmployees}
                                        selectedFamilyVisitEmployees={selectedFamilyVisitEmployees}
                                        selectedCompanyTripEmployees={selectedCompanyTripEmployees}
                                        selectedManagerRotationEmployees={selectedManagerRotationEmployees}
                                        onUpdateEmployee={updateEmployee}
                                        onAddEmployee={addEmployee}
                                        onDeleteEmployee={deleteEmployee}
                                        onUpdateSelection={handleUpdateSelection}
                                    />
                                </div>

                                <div className="flex justify-end pt-6 border-t border-gray-200">
                                    <Button onClick={handleSave} size="lg">
                                        <Save className="w-5 h-5 mr-2" />
                                        บันทึกทั้งหมด
                                    </Button>
                                </div>
                            </motion.div>
                        );

                    case 'travel':
                        return (
                            <motion.div
                                key="travel"
                                variants={contentVariants}
                                initial="initial"
                                animate="animate"
                                exit="exit"
                                transition={{ duration: 0.3 }}
                                className="space-y-6"
                            >
                                <TravelCalculationTable
                                    employees={employees}
                                    masterRates={masterRates}
                                    selectedEmployeeIds={selectedTravelEmployees}
                                    calcYear={calcYear}
                                    onSave={handleSave}
                                    onUpdateEmployee={updateEmployee}
                                />
                            </motion.div>
                        );

                    case 'special-assist':
                        return (
                            <motion.div
                                key="special-assist"
                                variants={contentVariants}
                                initial="initial"
                                animate="animate"
                                exit="exit"
                                transition={{ duration: 0.3 }}
                                className="space-y-6"
                            >
                                <SpecialAssistCalculationTable
                                    employees={employees}
                                    masterRates={masterRates}
                                    selectedEmployeeIds={selectedSpecialAssistEmployees}
                                    onSave={handleSave}
                                    onUpdateEmployee={updateEmployee}
                                />
                            </motion.div>
                        );

                    case 'family-visit':
                        return (
                            <motion.div
                                key="family-visit"
                                variants={contentVariants}
                                initial="initial"
                                animate="animate"
                                exit="exit"
                                transition={{ duration: 0.3 }}
                                className="space-y-6"
                            >
                                <FamilyVisitCalculationTable
                                    employees={employees}
                                    selectedEmployeeIds={selectedFamilyVisitEmployees}
                                    onSave={handleSave}
                                    onUpdateEmployee={updateEmployee}
                                />
                            </motion.div>
                        );

                    case 'workday-calc':
                        return (
                            <motion.div
                                key="workday-calc"
                                variants={contentVariants}
                                initial="initial"
                                animate="animate"
                                exit="exit"
                                transition={{ duration: 0.3 }}
                            >
                                <WorkDayCalculator
                                    calcYear={calcYear}
                                    holidaysData={holidaysData}
                                    onYearChange={setCalcYear}
                                    onAddHoliday={addHoliday}
                                    onDeleteHoliday={deleteHoliday}
                                    onSave={handleSave}
                                />
                            </motion.div>
                        );

                    default:
                        return (
                            <motion.div
                                key="placeholder"
                                variants={contentVariants}
                                initial="initial"
                                animate="animate"
                                exit="exit"
                                transition={{ duration: 0.3 }}
                            >
                                <Card>
                                    <div className="p-12 text-center">
                                        <p className="text-gray-500 text-lg">ฟีเจอร์นี้อยู่ระหว่างการพัฒนา</p>
                                        <p className="text-gray-400 mt-2">กรุณาเลือกแท็บอื่นเพื่อใช้งาน</p>
                                    </div>
                                </Card>
                            </motion.div>
                        );
                }
            };

            if (isLoading) {
                return <LoadingSpinner />;
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50">
                    <div className="container mx-auto px-4 py-8">
                        <motion.header
                            initial={{ opacity: 0, y: -20 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ duration: 0.5 }}
                            className="text-center mb-8"
                        >
                            <h1 className="text-4xl font-bold text-gray-900 mb-2">
                                ระบบจัดทำงบประมาณประจำปี
                            </h1>
                            <p className="text-gray-600 text-lg">
                                ระบบจัดการและคำนวณงบประมาณอย่างมีประสิทธิภาพ
                            </p>
                        </motion.header>

                        <TabNavigation activeTab={activeTab} onTabChange={setActiveTab} />

                        <AnimatePresence mode="wait">
                            {renderTabContent()}
                        </AnimatePresence>
                    </div>

                    <Toast
                        isVisible={toast.isVisible}
                        message={toast.message}
                        type={toast.type}
                        onClose={hideToast}
                    />
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>